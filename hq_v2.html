<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HQ COMMAND CENTER (ONLINE)</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --bg: #000; --text: #0f0; --border: #333; --highlight: #00ff41; --danger: #ff3333; }
        body { background: var(--bg); color: var(--text); font-family: 'Consolas', monospace; margin: 0; padding: 20px; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* HEADER & CONTROLS */
        .header { border-bottom: 2px solid var(--border); padding-bottom: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; font-size: 1.5rem; letter-spacing: 2px; }
        
        .control-panel { background: #111; border: 1px solid var(--border); padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .mode-switch { display: flex; gap: 20px; margin-bottom: 15px; align-items: center; }
        .radio-label { cursor: pointer; display: flex; align-items: center; color: #fff; }
        .radio-label input { margin-right: 8px; transform: scale(1.5); }
        
        .btn { background: #222; color: var(--highlight); border: 1px solid var(--highlight); padding: 10px 20px; font-size: 1rem; cursor: pointer; text-transform: uppercase; font-weight: bold; width: 100%; transition: 0.2s; }
        .btn:hover { background: var(--highlight); color: #000; }
        .btn:active { transform: scale(0.98); }

        /* DASHBOARD GRID */
        .dashboard { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; flex: 1; overflow-y: auto; align-content: start; }
        .grid-item { border: 1px solid #444; background: #0a0a0a; border-radius: 8px; padding: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; min-height: 100px; }
        
        .grid-item.solved { background: rgba(0, 255, 65, 0.2); border-color: var(--highlight); box-shadow: 0 0 15px var(--highlight); }
        .grid-item.solved::after { content: 'CLEARED'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-15deg); color: var(--highlight); font-size: 1.5rem; font-weight: 900; border: 3px solid var(--highlight); padding: 5px; opacity: 0.8; pointer-events: none; }

        .loc-label { position: absolute; top: 5px; left: 5px; font-size: 0.7rem; color: #666; }
        .item-icon { font-size: 3rem; margin-bottom: 5px; }
        .item-code { font-size: 1.2rem; font-weight: bold; color: #fff; background: #222; padding: 2px 8px; border-radius: 4px; }
        
        /* STATUS BAR */
        .status-bar { margin-top: 10px; color: #888; font-size: 0.8rem; text-align: center; }
        
        /* LOADING OVERLAY */
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; justify-content:center; align-items:center; z-index:99; display:none;}
        /* QR Code Modal Styles */
        .qr-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 200; justify-content: center; align-items: center; flex-direction: column; }
        .qr-box { background: #111; border: 2px solid var(--highlight); padding: 30px; border-radius: 10px; text-align: center; max-width: 90%; }
        .qr-code-img { margin: 20px auto; border: 10px solid #fff; } /* ç™½é‚Šè®“ QR æ›´å®¹æ˜“æƒ */
        .qr-link { color: var(--highlight); display: block; margin-top: 15px; text-decoration: underline; word-break: break-all; font-size: 0.9rem; }
        .close-btn { margin-top: 20px; background: var(--danger); color: #fff; border: none; padding: 10px 30px; font-size: 1.2rem; cursor: pointer; border-radius: 5px; }
        .mini-qr-btn { position: absolute; top: 5px; right: 5px; background: transparent; border: 1px solid #444; color: #666; cursor: pointer; padding: 2px 6px; font-size: 0.8rem; border-radius: 4px; z-index: 10; }
        .mini-qr-btn:hover { color: var(--highlight); border-color: var(--highlight); }
    </style>
</head>
<body>

    <div class="header">
        <h1>HQ MONITOR</h1>
        <div style="font-size:0.8rem; color:#666;">ONLINE VER.</div>
    </div>

    <div class="control-panel">
        <div class="mode-switch">
            <label class="radio-label">
                <input type="radio" name="gameMode" value="fixed" checked>
                å›ºå®šå¯†ç¢¼æ¨¡å¼ (Standard)
            </label>
            <label class="radio-label">
                <input type="radio" name="gameMode" value="random">
                éš¨æ©Ÿå¯†ç¢¼æ¨¡å¼ (Secure)
            </label>
        </div>
        <button class="btn" onclick="startNewGame()">âš  åˆå§‹åŒ–ä¸¦å•Ÿå‹•æ–°æˆ°å±€ âš </button>
        <button class="btn" style="margin-top:10px; border-color:#fff; color:#fff;" onclick="generateCodeBook()">ğŸ–¨ï¸ ç”¢ç”Ÿ/åˆ—å° å¯†ç¢¼å°ç…§è¡¨ (Code Book)</button>
    </div>

    <div id="dashboard" class="dashboard">
        <div style="grid-column: 1/-1; text-align:center; color:#444; padding-top:50px;">
            ç­‰å¾…å•Ÿå‹•æˆ°å±€...
        </div>
    </div>

    <div class="status-bar" id="status-text">SYSTEM STANDBY</div>
    <div id="loading"><div style="color:#fff; font-size:2rem;">PROCESSING...</div></div>
    <div id="qrModal" class="qr-modal">
    <div class="qr-box">
        <h2 id="qrTitle" style="color:var(--highlight); margin-top:0;">LOC X</h2>
        <div id="qrCanvas"></div>
        <a id="qrLink" href="#" target="_blank" class="qr-link">LINK</a>
        <button class="close-btn" onclick="closeQR()">CLOSE WINDOW</button>
        </div>
    </div>
    <script>
        // --- 1. CONFIGURATION (è«‹å¡«å…¥ä½ çš„ Supabase è³‡æ–™) ---
        const SUPABASE_URL = 'https://lqhgpeuoejdyodanvauv.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxxaGdwZXVvZWpkeW9kYW52YXV2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1MDUyMzAsImV4cCI6MjA3OTA4MTIzMH0.my3U8mN06xm79ArFamTpWydf7rYFXOKT5-ooKmqb_O4';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- 2. ASSET DATA ---
        
        // (1) å…±é€šç‰©å“æ¸…å–®ï¼šé€™æ˜¯å››å€‹å°éšŠæ›¸æœ¬è£¡éƒ½æœ‰çš„ç‰©å“ï¼Œç¢ºä¿éŠæˆ²é †æš¢ (é †åºå¾ˆé‡è¦ï¼Œè«‹å‹¿æ›´å‹•)
        const ITEMS_LIST = [
            // æ°´æœé¡ (12ç¨®)
            "è‘¡è„", "è¥¿ç“œ", "æ©˜å­", "æª¸æª¬", "è˜‹æœ", "æ¢¨å­", 
            "æ¤°å­", "èŠ’æœ", "å“ˆå¯†ç“œ", "ç•ªèŒ„", "è‰è“", "é³³æ¢¨",
            // å‹•ç‰©é¡ (6ç¨®)
            "ç…å­", "è€é·¹", "é±·é­š", "è²“é ­é·¹", "é•·é ¸é¹¿", "è¢‹é¼ ",
            // æ¤ç‰©é¡ (10ç¨®)
            "å‘æ—¥è‘µ", "ä»™äººæŒ", "ç«¹å­", "æ‰¶æ¡‘èŠ±", "æ¥“è‘‰", 
            "è–°è¡£è‰", "è–„è·", "æ¾æ¨¹", "é››èŠ", "è²æ®¼"
        ];

        // (2) å¯†ç¢¼ç¨®å­ï¼šå°æ‡‰ä¸Šæ–¹æ¸…å–®çš„å¯†ç¢¼
        const SEEDS = {
            // Alpha Team (A)
            A: [
                "L2Z5", "P8K3", "S4M1", "T4W7", "X4T9", "Q4Y9", 
                "B1D6", "K7X1", "V2C5", "O6A4", "U9E2", "Z3N7",
                "C7M1", "D5S2", "X2U5", "R9S6", "N3Y0", "G6P9",
                "G2V4", "B8H7", "L6P2", "F5G8", "Z7D5", 
                "K3I6", "E2A4", "J3R6", "C6U3", "P8M5"
            ],
            // Bravo Team (B)
            B: [
                "L3T6", "D8M3", "Z8A4", "W5Y3", "C5K1", "B2H9",
                "I1R8", "J9S0", "D1E5", "B6C9", "G7Q5", "U6Q4",
                "P5Q9", "B2C8", "H9I2", "D7E1", "W6X3", "U4V0",
                "F3G8", "H5I0", "U7V1", "L6N3", "Z7D5",
                "Z5A3", "B9C4", "O8P2", "W2Y6", "D1E8"
            ],
            // Charlie Team (C)
            C: [
                "G5H0", "K1L9", "M6N4", "C9D1", "Q0R2", "A4B7",
                "E2F6", "U7V9", "I8J3", "W2X5", "V1G5", "O3P7",
                "C2D8", "L0M9", "N4O6", "T5U0", "V9W3", "D0E5",
                "L2M7", "J6K8", "A3B6", "H1I5", "D0E4",
                "V1W6", "A9B3", "F9G2", "X7Z2", "C0D5"
            ],
            // Delta Team (D)
            D: [
                "G6I4", "L1M7", "W7Z1", "P9R3", "C8D0", "Q4Y9",
                "C2D6", "K7X1", "U0V6", "E8F3", "N5O2", "S4T8",
                "C9E4", "U8V3", "M4N9", "W5X0", "S1T7", "C6D2",
                "O3P5", "Q8R1", "S2T6", "F5G8", "U7V4",
                "Z9A3", "D1E6", "L4M9", "B8C2", "F5G0"
            ]
        };

        // (3) è‡ªå‹•ç”Ÿæˆå¯†ç¢¼å°ç…§è¡¨ (CODE_BOOKS)
        const CODE_BOOKS = { 'A': {}, 'B': {}, 'C': {}, 'D': {} };
        ITEMS_LIST.forEach((item, index) => {
            if(index < SEEDS.A.length) CODE_BOOKS.A[item] = SEEDS.A[index];
            if(index < SEEDS.B.length) CODE_BOOKS.B[item] = SEEDS.B[index];
            if(index < SEEDS.C.length) CODE_BOOKS.C[item] = SEEDS.C[index];
            if(index < SEEDS.D.length) CODE_BOOKS.D[item] = SEEDS.D[index];
        });

        // (4) éŠæˆ²è³‡ç”¢ (MASTER_ASSETS)
        // ç‚ºäº†è®“æ‚¨çš„ startNewGame é‚è¼¯èƒ½ç¹¼çºŒé‹ä½œï¼Œæˆ‘å€‘å¿…é ˆé‡å»ºé€™å€‹ç‰©ä»¶
        // ä½†é€™è£¡åªåŒ…å«ä¸Šé¢çš„ã€Œå®‰å…¨åå–®ã€å…§çš„ç‰©å“
        const MASTER_ASSETS = {
            fruits: [
                {n:"è‘¡è„", i:"ğŸ‡"}, {n:"è¥¿ç“œ", i:"ğŸ‰"}, {n:"æ©˜å­", i:"ğŸŠ"}, {n:"æª¸æª¬", i:"ğŸ‹"},
                {n:"è˜‹æœ", i:"ğŸ"}, {n:"æ¢¨å­", i:"ğŸ"}, {n:"æ¤°å­", i:"ğŸ¥¥"}, {n:"èŠ’æœ", i:"ğŸ¥­"},
                {n:"å“ˆå¯†ç“œ", i:"ğŸˆ"}, {n:"ç•ªèŒ„", i:"ğŸ…"}, {n:"è‰è“", i:"ğŸ“"}, {n:"é³³æ¢¨", i:"ğŸ"}
            ],
            animals: [
                {n:"ç…å­", i:"ğŸ¦"}, {n:"è€é·¹", i:"ğŸ¦…"}, {n:"é±·é­š", i:"ğŸŠ"},
                {n:"è²“é ­é·¹", i:"ğŸ¦‰"}, {n:"é•·é ¸é¹¿", i:"ğŸ¦’"}, {n:"è¢‹é¼ ", i:"ğŸ¦˜"}
            ],
            plants: [
                {n:"å‘æ—¥è‘µ", i:"ğŸŒ»"}, {n:"ä»™äººæŒ", i:"ğŸŒµ"}, {n:"ç«¹å­", i:"ğŸ‹"}, {n:"æ‰¶æ¡‘èŠ±", i:"ğŸŒº"},
                {n:"æ¥“è‘‰", i:"ğŸ"}, {n:"è–°è¡£è‰", i:"ğŸ’"}, {n:"è–„è·", i:"ğŸŒ¿"}, {n:"æ¾æ¨¹", i:"ğŸŒ²"},
                {n:"é››èŠ", i:"ğŸŒ¼"}, {n:"è²æ®¼", i:"ğŸš"}
            ]
        };
        
        // ç‚ºäº†ç›¸å®¹æ€§ï¼Œä¿ç•™é€™å€‹è®Šæ•¸ (æŒ‡å‘ Alpha å¯†ç¢¼æœ¬)
        const FIXED_CODE_MAP = CODE_BOOKS.A;

        // --- 3. LOGIC ---

        function shuffle(array) {
            return array.sort(() => Math.random() - 0.5);
        }

        function generateCodeBook() {
            // 1. è¨­å®šåˆ—å°æ¨£å¼ï¼šæ¯ä¸€é éƒ½æœ‰é‚Šæ¡†ï¼Œä¸¦ä¸”å¼·åˆ¶åˆ†é 
            let html = `<html><head><title>MISSION CODE BOOKS (ALL TEAMS)</title><style>
                body { font-family: "Microsoft JhengHei", sans-serif; -webkit-print-color-adjust: exact; }
                .page { 
                    page-break-after: always; /* é—œéµï¼šå¼·åˆ¶åˆ†é  */
                    padding: 40px; 
                    border: 5px solid #000; 
                    height: 95vh; 
                    box-sizing: border-box; 
                    position: relative;
                }
                h1 { text-align: center; border-bottom: 3px solid #000; margin-bottom: 10px; text-transform: uppercase; }
                .team-badge { 
                    text-align: center; font-size: 2.5rem; font-weight: 900; 
                    background: #000; color: #fff; padding: 10px; margin-bottom: 20px; 
                    border-radius: 8px;
                }
                .warning { color: red; text-align: center; font-weight: bold; margin-bottom: 20px; border: 2px solid red; padding: 5px; }
                .grid { 
                    display: grid; grid-template-columns: repeat(3, 1fr); 
                    gap: 15px; font-size: 1rem; 
                }
                .item { 
                    border-bottom: 1px dashed #ccc; padding: 5px; 
                    display: flex; justify-content: space-between; align-items: center; 
                }
                .name { font-weight: bold; }
                .code { font-family: 'Courier New', monospace; font-weight: 900; font-size: 1.2rem; letter-spacing: 1px;}
                
                /* æµ®æ°´å°æ•ˆæœ */
                .watermark {
                    position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg);
                    font-size: 8rem; opacity: 0.05; font-weight: bold; pointer-events: none; white-space: nowrap;
                }
            </style></head><body>`;

            // 2. å®šç¾©å››å€‹å°éšŠçš„è³‡è¨Š
            const teams = ['A', 'B', 'C', 'D'];
            const teamInfo = {
                'A': { name: 'ALPHA TEAM', color: '#FF3333' },
                'B': { name: 'BRAVO TEAM', color: '#33FF33' },
                'C': { name: 'CHARLIE TEAM', color: '#3388FF' },
                'D': { name: 'DELTA TEAM', color: '#FFFF33' }
            };

            // 3. è¿´åœˆç”Ÿæˆ 4 å€‹é é¢
            teams.forEach(team => {
                const bookData = CODE_BOOKS[team]; // æŠ“å–è©²å°éšŠå°ˆå±¬çš„å¯†ç¢¼
                const info = teamInfo[team];

                html += `
                <div class="page">
                    <div class="watermark">${info.name}</div>
                    <div class="team-badge" style="color:${info.color}">${info.name}</div>
                    <h1>å°ˆç”¨é€šè¨Šä»£ç¢¼æœ¬</h1>
                    <div class="warning">âš ï¸ æ©Ÿå¯†æ–‡ä»¶ï¼šåƒ…é™è©²å°éšŠä½¿ç”¨ï¼Œç¦æ­¢å‡ºç¤ºçµ¦ä»–éšŠè§€çœ‹ âš ï¸</div>
                    
                    <div class="grid">`;
                
                // åˆ—å°è©²å°éšŠçš„æ‰€æœ‰ç‰©å“èˆ‡å°æ‡‰å¯†ç¢¼
                // å…ˆä¾ç…§ç‰©å“åç¨±æ’åºï¼Œæ–¹ä¾¿æŸ¥æ‰¾
                Object.keys(bookData).sort().forEach(itemName => {
                    html += `
                    <div class="item">
                        <span class="name">${itemName}</span>
                        <span class="code">${bookData[itemName]}</span>
                    </div>`;
                });

                html += `
                    </div>
                    <div style="position: absolute; bottom: 20px; width: 100%; text-align: center; font-size: 0.8rem; color: #666;">
                        URBAN WATCHERS TACTICAL SYSTEM - DO NOT DISTRIBUTE
                    </div>
                </div>`;
            });

            html += `<script>window.print();<\/script></body></html>`;
            
            // 4. é–‹å•Ÿæ–°è¦–çª—åˆ—å°
            const printWin = window.open('', '_blank');
            printWin.document.write(html);
            printWin.document.close();
        }

        async function startNewGame() {
            if(!confirm("âš ï¸ ç¢ºå®šè¦å•Ÿå‹•æ–°æˆ°å±€ï¼Ÿ\né€™å°‡æœƒé‡ç½®ç›®å‰æ‰€æœ‰çš„é€£ç·šé€²åº¦ï¼")) return;
            
            document.getElementById('loading').style.display = 'flex';
            
            // --- 1. Create Session ---
            const { data: session, error: sessionError } = await supabase.from('game_sessions').insert([{ is_active: true }]).select().single();
            
            if(sessionError) { 
                document.getElementById('loading').style.display = 'none';
                alert(`ERROR: ç„¡æ³•å‰µå»ºæˆ°å±€ï¼\n${sessionError.message}`); 
                console.error(sessionError); 
                return; 
            }
            
            activeSessionId = session.id;

            // --- 2. Prepare Data (Shuffle Items) ---
            // é€™è£¡çš„éš¨æ©Ÿæ´—ç‰Œï¼Œå°±å·²ç¶“æä¾›äº†è¶³å¤ çš„éŠæˆ²è®ŠåŒ–æ€§
            const shuffledFruits = shuffle([...MASTER_ASSETS.fruits]);
            const shuffledAnimals = shuffle([...MASTER_ASSETS.animals]);
            const shuffledPlants = shuffle([...MASTER_ASSETS.plants]);

            const missions = [
                // Phase 1 (Fruits)
                { id: 'loc_1', cat: 'fruits', hint: 'å‰å¾€ LOC 5', comm: 'å‘¼å« B å°éšŠ(CH2)', target_book: 'B' }, 
                { id: 'loc_2', cat: 'fruits', hint: 'å‰å¾€ LOC 7', comm: 'å‘¼å« A å°éšŠ(CH1)', target_book: 'A' }, 
                { id: 'loc_3', cat: 'fruits', hint: 'å‰å¾€ LOC 6', comm: 'å‘¼å« D å°éšŠ(CH4)', target_book: 'D' }, 
                { id: 'loc_4', cat: 'fruits', hint: 'å‰å¾€ LOC 8', comm: 'å‘¼å« C å°éšŠ(CH3)', target_book: 'C' }, 
                // Phase 2 (Animals)
                { id: 'loc_5', cat: 'animals', hint: 'å‰å¾€ LOC 9',  comm: 'å‘¼å« C å°éšŠ(CH3)', target_book: 'C' },
                { id: 'loc_6', cat: 'animals', hint: 'å‰å¾€ LOC 11', comm: 'å‘¼å« D å°éšŠ(CH4)', target_book: 'D' },
                { id: 'loc_7', cat: 'animals', hint: 'å‰å¾€ LOC 10', comm: 'å‘¼å« A å°éšŠ(CH1)', target_book: 'A' },
                { id: 'loc_8', cat: 'animals', hint: 'å‰å¾€ LOC 12', comm: 'å‘¼å« B å°éšŠ(CH2)', target_book: 'B' },
                // Phase 3 (Plants)
                { id: 'loc_9',  cat: 'plants', hint: 'MISSION COMPLETE', comm: 'å›å ± HQ', target_book: 'B' },
                { id: 'loc_10', cat: 'plants', hint: 'MISSION COMPLETE', comm: 'å›å ± HQ', target_book: 'A' },
                { id: 'loc_11', cat: 'plants', hint: 'MISSION COMPLETE', comm: 'å›å ± HQ', target_book: 'D' },
                { id: 'loc_12', cat: 'plants', hint: 'MISSION COMPLETE', comm: 'å›å ± HQ', target_book: 'C' }
            ];

            const payload = missions.map((m, idx) => {
                let asset;
                if(m.cat === 'fruits') asset = shuffledFruits.pop();
                else if(m.cat === 'animals') asset = shuffledAnimals.pop();
                else asset = shuffledPlants.pop();

                // â˜… å¼·åˆ¶ä½¿ç”¨å¯†ç¢¼æœ¬ (å› ç‚ºæˆ‘å€‘å·²ç¶“æœ‰ç´™æœ¬äº†)
                // æ ¹æ“š target_book æŸ¥è¡¨ (ä¾‹å¦‚ LOC 1 æŸ¥ Book B çš„å¯†ç¢¼)
                let code = CODE_BOOKS[m.target_book][asset.n];
                
                // é˜²å‘†ï¼šè¬ä¸€çœŸçš„æœ‰æ¼ç¶²ä¹‹é­šæŸ¥ä¸åˆ°ï¼Œæ‰çµ¦äº‚æ•¸ (ç†è«–ä¸Šä¸è©²ç™¼ç”Ÿ)
                if(!code) {
                    console.error(`Missing code for ${asset.n} in Book ${m.target_book}`);
                    code = generateRandomCode(); 
                }

                return {
                    session_id: activeSessionId,
                    location_id: m.id,
                    name: asset.n,
                    icon: asset.i,
                    code: code,
                    category: m.cat,
                    next_hint: m.hint,
                    comm_msg: m.comm
                };
            });

            // --- 3. Upload ---
            const { error: missionError } = await supabase.from('mission_states').insert(payload);
            
            if(missionError) {
                document.getElementById('loading').style.display = 'none';
                alert(`ERROR: ç„¡æ³•ä¸Šå‚³ä»»å‹™ï¼\n${missionError.message}`);
                console.error(missionError);
                return;
            }
            
            // --- 4. Finish ---
            document.getElementById('loading').style.display = 'none';
            // ç‹€æ…‹åˆ—ç°¡åŒ–é¡¯ç¤º
            document.getElementById('status-text').innerText = `SESSION ACTIVE: ${activeSessionId.split('-')[0]}...`;
            
            renderDashboard(payload);
            startListening();
        }

        function renderDashboard(data) {
            const container = document.getElementById('dashboard');
            container.innerHTML = '';
            
            // Sort by ID order: loc_1... loc_8, hq_a...
            // (Simple mapping for display order)
            const order = ['loc_1','loc_2','loc_3','loc_4','loc_5','loc_6','loc_7','loc_8','loc_9','loc_10','loc_11','loc_12'];
            
            data.sort((a,b) => order.indexOf(a.location_id) - order.indexOf(b.location_id));

            data.forEach(item => {
                const div = document.createElement('div');
                div.className = `grid-item ${item.is_solved ? 'solved' : ''}`;
                div.id = `card-${item.location_id}`;
                div.innerHTML = `
                    <div class="loc-label">${item.location_id.toUpperCase()}</div>
                    <button class="mini-qr-btn" onclick="generateQR('${item.location_id}')">ğŸ“± QR</button>
                    <div class="item-icon">${item.icon}</div>
                    <div class="item-code">${item.code}</div>
                `;
                container.appendChild(div);
            });
        }

let currentChannel = null;

        function startListening() {
            // 1. å¦‚æœæœ‰èˆŠé »é“ï¼Œå…ˆç§»é™¤ï¼Œç¢ºä¿ä¹¾æ·¨
            if (currentChannel) {
                supabase.removeChannel(currentChannel);
            }

            console.log(`ğŸ“¡ å•Ÿå‹•ç›£è½... ç›®æ¨™ Session ID: ${activeSessionId}`);

            // 2. è¨‚é–±æ•´å€‹ mission_states è¡¨æ ¼ (ä¸è¨­ filter)
            currentChannel = supabase.channel('room-global')
            .on(
                'postgres_changes', 
                { 
                    event: 'UPDATE', 
                    schema: 'public', 
                    table: 'mission_states' 
                }, 
                (payload) => {
                    console.log("ğŸ“¨ æ”¶åˆ°è®Šæ›´è¨Šè™Ÿï¼", payload);

                    // 3. ã€é—œéµã€‘åœ¨é€™é‚Šè‡ªå·±æª¢æŸ¥ ID (å‰ç«¯éæ¿¾)
                    // å¦‚æœæ”¶åˆ°çš„è³‡æ–™ session_id ä¸ç­‰æ–¼ç•¶å‰æˆ°å±€ IDï¼Œå°±å¿½ç•¥
                    if (payload.new.session_id !== activeSessionId) {
                        console.log("Ignoring update from other session.");
                        return;
                    }

                    // 4. æ›´æ–°ç•«é¢
                    const updated = payload.new;
                    if (updated.is_solved) {
                        const card = document.getElementById(`card-${updated.location_id}`);
                        if (card) {
                            console.log(`âœ… å‘½ä¸­ï¼æ›´æ–°å¡ç‰‡: ${updated.location_id}`);
                            card.classList.add('solved');
                        }
                    }
                }
            )
            .subscribe((status) => {
                console.log(`ğŸ“¶ é€£ç·šç‹€æ…‹: ${status}`);
                if (status === 'SUBSCRIBED') {
                    console.log("ğŸš€ å³æ™‚ç›£æ§å·²é€£ç·šï¼ç¾åœ¨ä¸éœ€è¦ F5 äº†ï¼");
                }
            });
        }

        // On Load: Try to fetch latest active session
        window.onload = async () => {
             const { data: sessions } = await supabase.from('game_sessions').select('id').eq('is_active', true).order('created_at', { ascending: false }).limit(1);
             if(sessions && sessions.length > 0) {
                 activeSessionId = sessions[0].id;
                 const { data: missions } = await supabase.from('mission_states').select('*').eq('session_id', activeSessionId);
                 if(missions) {
                     renderDashboard(missions);
                     startListening();
                     document.getElementById('status-text').innerText = `RESUMED SESSION: ${activeSessionId.split('-')[0]}...`;
                 }
             }
        }
        function generateQR(locId) {
        // 1. è¨ˆç®— mission_v2.html çš„å®Œæ•´ç¶²å€
        // è‡ªå‹•æŠ“å–ç•¶å‰ç¶²å€è·¯å¾‘ï¼ŒæŠŠ hq_v2.html æ›æˆ mission_v2.html
        const baseUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/'));
        const fullUrl = `${baseUrl}/mission_v2.html?id=${locId}`;

        // 2. è¨­å®š UI
        document.getElementById('qrTitle').innerText = `SCAN TO ACCESS: ${locId.toUpperCase()}`;
        document.getElementById('qrLink').innerText = fullUrl;
        document.getElementById('qrLink').href = fullUrl;
        document.getElementById('qrCanvas').innerHTML = ""; // æ¸…ç©ºèˆŠåœ–

        // 3. ç”¢ç”Ÿ QR Code
        new QRCode(document.getElementById("qrCanvas"), {
            text: fullUrl,
            width: 250,
            height: 250,
            colorDark : "#000000",
            colorLight : "#ffffff",
            correctLevel : QRCode.CorrectLevel.H
        });

        // 4. é¡¯ç¤ºè¦–çª—
        document.getElementById('qrModal').style.display = 'flex';
    }

    function closeQR() {
        document.getElementById('qrModal').style.display = 'none';
    }
    function generateCodeBook() {
    // 1. æº–å‚™ HTML æ¨™é ­
    let html = `
        <html>
        <head>
            <title>é€šè¨Šä»£ç¢¼å°ç…§è¡¨ (Code Book)</title>
            <style>
                body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; }
                h1 { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; }
                .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 20px; }
                .item { border: 1px solid #ccc; padding: 5px 10px; display: flex; justify-content: space-between; align-items: center; }
                .name { font-weight: bold; font-size: 1.1rem; }
                .code { font-family: "Courier New", monospace; font-weight: bold; font-size: 1.2rem; background: #eee; padding: 2px 6px; border-radius: 4px; }
                @media print { .btn-print { display: none; } }
            </style>
        </head>
        <body>
            <h1>ğŸ“ æ©Ÿå¯†ä»»å‹™ï¼šé€šè¨Šä»£ç¢¼å°ç…§è¡¨</h1>
            <div style="text-align:center; margin-bottom:20px; color:#666;">
                âš ï¸ åƒ…ä¾›é€šè¨Šå®˜ä½¿ç”¨ï¼Œè«‹å¦¥å–„ä¿ç®¡ã€‚
            </div>
            <div class="grid">
    `;

    // 2. è®€å– FIXED_CODE_MAP ä¸¦ç”Ÿæˆè¡¨æ ¼
    // ç‚ºäº†ç¾è§€ï¼Œæˆ‘å€‘ä¾æ“šæ³¨éŸ³æˆ–ç­†ç•«ç¨å¾®æ’åºä¸€ä¸‹ (é€™è£¡ç°¡å–®ç”¨ key æ’åº)
    const sortedKeys = Object.keys(FIXED_CODE_MAP).sort();
    
    sortedKeys.forEach(key => {
        html += `
            <div class="item">
                <span class="name">${key}</span>
                <span class="code">${FIXED_CODE_MAP[key]}</span>
            </div>
        `;
    });

    // 3. çµå°¾
    html += `
            </div>
            <div style="margin-top:30px; text-align:center; font-size:0.8rem; color:#999;">
                GENERATED BY URBAN WATCHERS HQ SYSTEM
            </div>
            <script>window.print();<\/script>
        </body>
        </html>
    `;

    // 4. é–‹å•Ÿæ–°è¦–çª—åˆ—å°
    const printWin = window.open('', '_blank');
    printWin.document.write(html);
    printWin.document.close();
}    

    </script>
</body>
</html>
