<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HQ COMMAND CENTER (ONLINE)</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --bg: #000; --text: #0f0; --border: #333; --highlight: #00ff41; --danger: #ff3333; }
        body { background: var(--bg); color: var(--text); font-family: 'Consolas', monospace; margin: 0; padding: 20px; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* HEADER & CONTROLS */
        .header { border-bottom: 2px solid var(--border); padding-bottom: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; font-size: 1.5rem; letter-spacing: 2px; }
        
        .control-panel { background: #111; border: 1px solid var(--border); padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .mode-switch { display: flex; gap: 20px; margin-bottom: 15px; align-items: center; }
        .radio-label { cursor: pointer; display: flex; align-items: center; color: #fff; }
        .radio-label input { margin-right: 8px; transform: scale(1.5); }
        
        .btn { background: #222; color: var(--highlight); border: 1px solid var(--highlight); padding: 10px 20px; font-size: 1rem; cursor: pointer; text-transform: uppercase; font-weight: bold; width: 100%; transition: 0.2s; }
        .btn:hover { background: var(--highlight); color: #000; }
        .btn:active { transform: scale(0.98); }

        /* DASHBOARD GRID */
        .dashboard { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; flex: 1; overflow-y: auto; align-content: start; }
        .grid-item { border: 1px solid #444; background: #0a0a0a; border-radius: 8px; padding: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; min-height: 100px; }
        
        .grid-item.solved { background: rgba(0, 255, 65, 0.2); border-color: var(--highlight); box-shadow: 0 0 15px var(--highlight); }
        .grid-item.solved::after { content: 'CLEARED'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-15deg); color: var(--highlight); font-size: 1.5rem; font-weight: 900; border: 3px solid var(--highlight); padding: 5px; opacity: 0.8; pointer-events: none; }

        .loc-label { position: absolute; top: 5px; left: 5px; font-size: 0.7rem; color: #666; }
        .item-icon { font-size: 3rem; margin-bottom: 5px; }
        .item-code { font-size: 1.2rem; font-weight: bold; color: #fff; background: #222; padding: 2px 8px; border-radius: 4px; }
        
        /* STATUS BAR */
        .status-bar { margin-top: 10px; color: #888; font-size: 0.8rem; text-align: center; }
        
        /* LOADING OVERLAY */
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; justify-content:center; align-items:center; z-index:99; display:none;}
        /* QR Code Modal Styles */
        .qr-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 200; justify-content: center; align-items: center; flex-direction: column; }
        .qr-box { background: #111; border: 2px solid var(--highlight); padding: 30px; border-radius: 10px; text-align: center; max-width: 90%; }
        .qr-code-img { margin: 20px auto; border: 10px solid #fff; } /* ç™½é‚Šè®“ QR æ›´å®¹æ˜“æƒ */
        .qr-link { color: var(--highlight); display: block; margin-top: 15px; text-decoration: underline; word-break: break-all; font-size: 0.9rem; }
        .close-btn { margin-top: 20px; background: var(--danger); color: #fff; border: none; padding: 10px 30px; font-size: 1.2rem; cursor: pointer; border-radius: 5px; }
        .mini-qr-btn { position: absolute; top: 5px; right: 5px; background: transparent; border: 1px solid #444; color: #666; cursor: pointer; padding: 2px 6px; font-size: 0.8rem; border-radius: 4px; z-index: 10; }
        .mini-qr-btn:hover { color: var(--highlight); border-color: var(--highlight); }
    </style>
</head>
<body>

    <div class="header">
        <h1>HQ MONITOR</h1>
        <div style="font-size:0.8rem; color:#666;">ONLINE VER.</div>
    </div>

    <div class="control-panel">
        <div class="mode-switch">
            <label class="radio-label">
                <input type="radio" name="gameMode" value="fixed" checked>
                å›ºå®šå¯†ç¢¼æ¨¡å¼ (Standard)
            </label>
            <label class="radio-label">
                <input type="radio" name="gameMode" value="random">
                éš¨æ©Ÿå¯†ç¢¼æ¨¡å¼ (Secure)
            </label>
        </div>
        <button class="btn" onclick="startNewGame()">âš  åˆå§‹åŒ–ä¸¦å•Ÿå‹•æ–°æˆ°å±€ âš </button>
        <button class="btn" style="margin-top:10px; border-color:#fff; color:#fff;" onclick="generateCodeBook()">ğŸ–¨ï¸ ç”¢ç”Ÿ/åˆ—å° å¯†ç¢¼å°ç…§è¡¨ (Code Book)</button>
    </div>

    <div id="dashboard" class="dashboard">
        <div style="grid-column: 1/-1; text-align:center; color:#444; padding-top:50px;">
            ç­‰å¾…å•Ÿå‹•æˆ°å±€...
        </div>
    </div>

    <div class="status-bar" id="status-text">SYSTEM STANDBY</div>
    <div id="loading"><div style="color:#fff; font-size:2rem;">PROCESSING...</div></div>
    <div id="qrModal" class="qr-modal">
    <div class="qr-box">
        <h2 id="qrTitle" style="color:var(--highlight); margin-top:0;">LOC X</h2>
        <div id="qrCanvas"></div>
        <a id="qrLink" href="#" target="_blank" class="qr-link">LINK</a>
        <button class="close-btn" onclick="closeQR()">CLOSE WINDOW</button>
        </div>
    </div>
    <script>
        // --- 1. CONFIGURATION (è«‹å¡«å…¥ä½ çš„ Supabase è³‡æ–™) ---
        const SUPABASE_URL = 'https://lqhgpeuoejdyodanvauv.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxxaGdwZXVvZWpkeW9kYW52YXV2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1MDUyMzAsImV4cCI6MjA3OTA4MTIzMH0.my3U8mN06xm79ArFamTpWydf7rYFXOKT5-ooKmqb_O4';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- 2. ASSET DATA ---
        const MASTER_ASSETS = {
            fruits: [ 
                {i:"ğŸ", n:"è˜‹æœ"}, {i:"ğŸŒ", n:"é¦™è•‰"}, {i:"ğŸ‡", n:"è‘¡è„"}, {i:"ğŸ‰", n:"è¥¿ç“œ"}, 
                {i:"ğŸŠ", n:"æ©˜å­"}, {i:"ğŸ‹", n:"æª¸æª¬"}, {i:"ğŸ‘", n:"æ¡ƒå­"}, {i:"ğŸ’", n:"æ«»æ¡ƒ"}, 
                {i:"ğŸ", n:"æ¢¨å­"}, {i:"ğŸ¥¥", n:"æ¤°å­"}, {i:"ğŸ¥‘", n:"é…ªæ¢¨"}, {i:"ğŸ¥­", n:"èŠ’æœ"}, 
                {i:"ğŸˆ", n:"å“ˆå¯†ç“œ"}, {i:"ğŸ…", n:"ç•ªèŒ„"}, {i:"ğŸ“", n:"è‰è“"}, {i:"ğŸ", n:"é³³æ¢¨"} 
            ],
            animals: [
                {i:"ğŸ¦", n:"ç…å­"}, {i:"ğŸ¯", n:"è€è™"}, {i:"ğŸ»", n:"ç†Š"}, {i:"ğŸº", n:"ç‹¼"}, 
                {i:"ğŸ¦…", n:"è€é·¹"}, {i:"ğŸ¦ˆ", n:"é¯Šé­š"}, {i:"ğŸ¦“", n:"æ–‘é¦¬"}, {i:"ğŸ†", n:"çµè±¹"}, 
                {i:"ğŸ³", n:"é¯¨é­š"}, {i:"ğŸ¦˜", n:"è¢‹é¼ "}, {i:"ğŸŠ", n:"é±·é­š"}, {i:"ğŸ¦", n:"å¤§çŒ©çŒ©"}, 
                {i:"ğŸ¦›", n:"æ²³é¦¬"}, {i:"ğŸ¦’", n:"é•·é ¸é¹¿"}, {i:"ğŸ¦‡", n:"è™è "}, {i:"ğŸ¦‰", n:"è²“é ­é·¹"}, 
                {i:"ğŸ˜", n:"å¤§è±¡"}, {i:"ğŸ¦Š", n:"ç‹ç‹¸"}, {i:"ğŸ¼", n:"ç†Šè²“"}, {i:"ğŸ", n:"è›‡"}
            ],
            plants: [
                {i:"ğŸ€", n:"å¹¸é‹è‰"}, {i:"ğŸŒ´", n:"æ¤°å­æ¨¹"}, {i:"ğŸŒµ", n:"ä»™äººæŒ"}, {i:"ğŸŒ²", n:"æ¾æ¨¹"},
                {i:"ğŸŒ»", n:"å‘æ—¥è‘µ"}, {i:"ğŸ‹", n:"ç«¹å­"}, {i:"ğŸ„", n:"è˜‘è‡"}, {i:"ğŸŒº", n:"æ‰¶æ¡‘èŠ±"}, 
                {i:"ğŸ", n:"æ¥“è‘‰"}, {i:"ğŸ’", n:"è–°è¡£è‰"}, {i:"ğŸŒ¿", n:"è–„è·"}, {i:"ğŸŒ¾", n:"å°éº¥"}, 
                {i:"ğŸŒ¼", n:"é››èŠ"}, {i:"ğŸŒ¹", n:"ç«ç‘°"}, {i:"ğŸŒ·", n:"é¬±é‡‘é¦™"}, {i:"ğŸš", n:"è²æ®¼"}
            ]
        };

        const FIXED_CODE_MAP = {
            "è˜‹æœ": "X4T9", "é¦™è•‰": "A3O7", "è‘¡è„": "L2Z5", "è¥¿ç“œ": "P8K3", "æ©˜å­": "S4M1", "æª¸æª¬": "T4W7", "æ¡ƒå­": "N8R3", "æ«»æ¡ƒ": "E9I2", "æ¢¨å­": "Q4Y9", "æ¤°å­": "B1D6", "é…ªæ¢¨": "H5J0", "ç³–æœ": "F3G8", "èŠ’æœ": "K7X1", "å“ˆå¯†ç“œ": "V2C5", "ç•ªèŒ„": "O6A4", "è‰è“": "V1G5", "é³³æ¢¨": "Z3N7",
            "è€é·¹": "D5S2", "è›‡": "W9F0", "é¯Šé­š": "H1J3", "æ–‘é¦¬": "O3A0", "é¯¨é­š": "V2D6", "çµè±¹": "K8B4", "è¢‹é¼ ": "G6P9", "ç…å­": "C7M1", "é±·é­š": "X2U5", "å¤§çŒ©çŒ©": "T1I8", "æ²³é¦¬": "E4Z7", "é•·é ¸é¹¿": "N3Y0", "è™è ": "Q5L2", "è²“é ­é·¹": "R9S6", "é§±é§": "M7H3", "å­”é›€": "A0F1", "è€è™": "Y5N8", "å¤§è±¡": "S2K9", "ç‹¼": "F6B2", "ç†Š": "R3Z5", "ç‹ç‹¸": "M8O2", "ç†Šè²“": "K4L0",
            "å‘æ—¥è‘µ": "G2V4", "ä»™äººæŒ": "H5I0", "ç«¹å­": "L6P2", "è˜‘è‡": "S8M2", "æ‰¶æ¡‘èŠ±": "F5G8", "æ©¡æ¨¹": "T1Q9", "æ¥“è‘‰": "Z7D5", "æ¾æ¨¹": "J3R6", "è–°è¡£è‰": "K3I6", "è–„è·": "E2A4", "å°éº¥": "Y9X1", "è˜†è‘¦": "O5N0", "è½è‘‰": "H4W8", "é››èŠ": "C6U3", "æˆ¿å±‹": "V0S7", "è²æ®¼": "P8M5", "ç«ç‘°": "M4X0", "æ¤°å­æ¨¹": "C5Y9", "é¬±é‡‘é¦™": "J1K7", "ç¨»ç©—": "Q4R9", "å¹¸é‹è‰": "N9T4"
        };

        let activeSessionId = null;

        // --- 3. LOGIC ---

        function shuffle(array) {
            return array.sort(() => Math.random() - 0.5);
        }

        function generateRandomCode() {
            const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789"; // æ’é™¤å®¹æ˜“æ··æ·†çš„ I, 1, O, 0 (é›–ç„¶æœ‰æ¨¡ç³Šæ¯”å°ï¼Œä½†è¦–è¦ºä¸Šé¿å…ä¹Ÿå¥½)
            let result = "";
            for(let i=0; i<4; i++) result += chars.charAt(Math.floor(Math.random() * chars.length));
            return result;
        }

        async function startNewGame() {
Â  Â  Â  Â  Â  Â  if(!confirm("âš ï¸ ç¢ºå®šè¦å•Ÿå‹•æ–°æˆ°å±€ï¼Ÿ\né€™å°‡æœƒé‡ç½®ç›®å‰æ‰€æœ‰çš„é€£ç·šé€²åº¦ï¼")) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  document.getElementById('loading').style.display = 'flex';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const mode = document.querySelector('input[name="gameMode"]:checked').value;
Â  Â  Â  Â  Â  Â  const isFixed = (mode === 'fixed');

Â  Â  Â  Â  Â  Â  // 1. Create Session
Â  Â  Â  Â  Â  Â  const { data: session, error: sessionError } = await supabase.from('game_sessions').insert([{ is_active: true }]).select().single();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if(sessionError) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('loading').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  alert(`ERROR: ç„¡æ³•å‰µå»ºæˆ°å±€ï¼Œè«‹æª¢æŸ¥ RLS INSERT æ¬Šé™ï¼\nè©³æƒ…ï¼š${sessionError.message}`);Â 
Â  Â  Â  Â  Â  Â  Â  Â  console.error(sessionError);Â 
Â  Â  Â  Â  Â  Â  Â  Â  return;Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  activeSessionId = session.id;

Â  Â  Â  Â  Â  Â  // 2. Prepare Data
Â  Â  Â  Â  Â  Â  const shuffledFruits = shuffle([...MASTER_ASSETS.fruits]);
Â  Â  Â  Â  Â  Â  const shuffledAnimals = shuffle([...MASTER_ASSETS.animals]);
Â  Â  Â  Â  Â  Â  const shuffledPlants = shuffle([...MASTER_ASSETS.plants]);

Â  Â  Â  Â  Â  Â  const missions = [
Â  Â  Â  Â  Â  Â  Â  Â  // Phase 1 (Fruits)
Â  Â  Â  Â  Â  Â  Â  Â  { id: 'loc_1', cat: 'fruits', hint: 'å‰å¾€ LOC 5', comm: 'åˆ‡æ›è‡³ [ä¸»é » CH1 / å‚™é » CH3]ã€‚\nåˆ‡æ›å¾Œï¼Œè«‹å‘¼å«è©²é »é“çš„å‹è»å–®ä½ã€‚' },
Â  Â  Â  Â  Â  Â  Â  Â  { id: 'loc_2', cat: 'fruits', hint: 'å‰å¾€ LOC 7', comm: 'ä¿æŒç•¶å‰é »é“ã€‚\nè«‹éœå€™å‹è»å–®ä½èˆ‡ä½ å€‘è¯ç¹«ã€‚' },
Â  Â  Â  Â  Â  Â  Â  Â  { id: 'loc_3', cat: 'fruits', hint: 'å‰å¾€ LOC 6', comm: 'ä¿æŒç•¶å‰é »é“ã€‚\nè«‹éœå€™å‹è»å–®ä½èˆ‡ä½ å€‘è¯ç¹«ã€‚' },
Â  Â  Â  Â  Â  Â  Â  Â  { id: 'loc_4', cat: 'fruits', hint: 'å‰å¾€ LOC 8', comm: 'åˆ‡æ›è‡³ [ä¸»é » CH2 / å‚™é » CH4]ã€‚\nåˆ‡æ›å¾Œï¼Œè«‹å‘¼å«è©²é »é“çš„å‹è»å–®ä½ã€‚' },
Â  Â  Â  Â  Â  Â  Â  Â  // Phase 2 (Animals)
Â  Â  Â  Â  Â  Â  Â  Â  { id: 'loc_5', cat: 'animals', hint: 'å‰å¾€ LOC 9', comm: 'åˆ‡æ›è‡³ [ä¸»é » CH1 / å‚™é » CH3]ã€‚\nåˆ‡æ›å¾Œï¼Œè«‹å‘¼å«è©²é »é“çš„å‹è»å–®ä½ã€‚' },
Â  Â  Â  Â  Â  Â  Â  Â  { id: 'loc_6', cat: 'animals', hint: 'å‰å¾€ LOC 11', comm: 'ä¿æŒç•¶å‰é »é“ã€‚\nè«‹éœå€™å‹è»å–®ä½èˆ‡ä½ å€‘è¯ç¹«ã€‚' },
Â  Â  Â  Â  Â  Â  Â  Â  { id: 'loc_7', cat: 'animals', hint: 'å‰å¾€ LOC 10', comm: 'åˆ‡æ›è‡³ [ä¸»é » CH2 / å‚™é » CH4]ã€‚\nåˆ‡æ›å¾Œï¼Œè«‹å‘¼å«è©²é »é“çš„å‹è»å–®ä½ã€‚' },
Â  Â  Â  Â  Â  Â  Â  Â  { id: 'loc_8', cat: 'animals', hint: 'å‰å¾€ LOC 12', comm: 'ä¿æŒç•¶å‰é »é“ã€‚\nè«‹éœå€™å‹è»å–®ä½èˆ‡ä½ å€‘è¯ç¹«ã€‚' },
Â  Â  Â  Â  Â  Â  Â  Â  // Phase 3 (Plants)
Â  Â  Â  Â  Â  Â  Â  Â  { id: 'loc_9', cat: 'plants', hint: 'MISSION ACCOMPLISHED', comm: 'åˆ‡æ›è‡³ [æ•‘æ´é »é“]ã€‚\n\n1. è«‹ç«‹å³æ¸…é»å°çµ„äººæ•¸åŠè£å‚™ã€‚\n2. ä½¿ç”¨ç„¡ç·šé›»å‘ HQ å›å ±ï¼š\nÂ  Â ä»»å‹™ä»£è™Ÿã€æ‹“æ’²é‡æ§‹ã€å·²å®Œæˆã€‚\n3. åŸåœ°å¾…å‘½ï¼Œç­‰å¾… HQ ä¸‹ä¸€æ­¥æŒ‡ç¤ºã€‚' },
Â  Â  Â  Â  Â  Â  Â  Â  { id: 'loc_10', cat: 'plants', hint: 'MISSION ACCOMPLISHED', comm: 'åˆ‡æ›è‡³ [æ•‘æ´é »é“]ã€‚\n\n1. è«‹ç«‹å³æ¸…é»å°çµ„äººæ•¸åŠè£å‚™ã€‚\n2. ä½¿ç”¨ç„¡ç·šé›»å‘ HQ å›å ±ï¼š\nÂ  Â ä»»å‹™ä»£è™Ÿã€æ‹“æ’²é‡æ§‹ã€å·²å®Œæˆã€‚\n3. åŸåœ°å¾…å‘½ï¼Œç­‰å¾… HQ ä¸‹ä¸€æ­¥æŒ‡ç¤ºã€‚' },
Â  Â  Â  Â  Â  Â  Â  Â  { id: 'loc_11', cat: 'plants', hint: 'MISSION ACCOMPLISHED', comm: 'åˆ‡æ›è‡³ [æ•‘æ´é »é“]ã€‚\n\n1. è«‹ç«‹å³æ¸…é»å°çµ„äººæ•¸åŠè£å‚™ã€‚\n2. ä½¿ç”¨ç„¡ç·šé›»å‘ HQ å›å ±ï¼š\nÂ  Â ä»»å‹™ä»£è™Ÿã€æ‹“æ’²é‡æ§‹ã€å·²å®Œæˆã€‚\n3. åŸåœ°å¾…å‘½ï¼Œç­‰å¾… HQ ä¸‹ä¸€æ­¥æŒ‡ç¤ºã€‚' },
Â  Â  Â  Â  Â  Â  Â  Â  { id: 'loc_12', cat: 'plants', hint: 'MISSION ACCOMPLISHED', comm: 'åˆ‡æ›è‡³ [æ•‘æ´é »é“]ã€‚\n\n1. è«‹ç«‹å³æ¸…é»å°çµ„äººæ•¸åŠè£å‚™ã€‚\n2. ä½¿ç”¨ç„¡ç·šé›»å‘ HQ å›å ±ï¼š\nÂ  Â ä»»å‹™ä»£è™Ÿã€æ‹“æ’²é‡æ§‹ã€å·²å®Œæˆã€‚\n3. åŸåœ°å¾…å‘½ï¼Œç­‰å¾… HQ ä¸‹ä¸€æ­¥æŒ‡ç¤ºã€‚' }
Â  Â  Â  Â  Â  Â  ];

Â  Â  Â  Â  Â  Â  const payload = missions.map((m, idx) => {
Â  Â  Â  Â  Â  Â  Â  Â  let asset;
Â  Â  Â  Â  Â  Â  Â  Â  if(m.cat === 'fruits') asset = shuffledFruits.pop();
Â  Â  Â  Â  Â  Â  Â  Â  else if(m.cat === 'animals') asset = shuffledAnimals.pop();
Â  Â  Â  Â  Â  Â  Â  Â  else asset = shuffledPlants.pop();

Â  Â  Â  Â  Â  Â  Â  Â  // æ±ºå®šå¯†ç¢¼ï¼šå›ºå®šæ¨¡å¼æŸ¥è¡¨ï¼Œéš¨æ©Ÿæ¨¡å¼äº‚æ•¸
Â  Â  Â  Â  Â  Â  Â  Â  let code = isFixed ? FIXED_CODE_MAP[asset.n] : generateRandomCode();
Â  Â  Â  Â  Â  Â  Â  Â  if(!code) code = generateRandomCode(); // Fallback

Â  Â  Â  Â  Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  session_id: activeSessionId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  location_id: m.id,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name: asset.n,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  icon: asset.i,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  code: code,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  category: m.cat,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  next_hint: m.hint,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  comm_msg: m.comm
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // 3. Upload Mission States
Â  Â  Â  Â  Â  Â  const { error: missionError } = await supabase.from('mission_states').insert(payload);
            Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if(missionError) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('loading').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  alert(`ERROR: ç„¡æ³•ä¸Šå‚³ä»»å‹™ï¼Œè«‹æª¢æŸ¥ RLS INSERT æ¬Šé™ï¼\nè©³æƒ…ï¼š${missionError.message}`);
Â  Â  Â  Â  Â  Â  Â  Â  console.error(missionError);
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('status-text').innerText = `SESSION ACTIVE: ${activeSessionId.split('-')[0]}... [${isFixed ? 'FIXED' : 'RANDOM'}]`;
            
            // 4. Render & Listen
            renderDashboard(payload);
            startListening();
Â  Â  Â  Â  }

        function renderDashboard(data) {
            const container = document.getElementById('dashboard');
            container.innerHTML = '';
            
            // Sort by ID order: loc_1... loc_8, hq_a...
            // (Simple mapping for display order)
            const order = ['loc_1','loc_2','loc_3','loc_4','loc_5','loc_6','loc_7','loc_8','loc_9','loc_10','loc_11','loc_12'];
            
            data.sort((a,b) => order.indexOf(a.location_id) - order.indexOf(b.location_id));

            data.forEach(item => {
                const div = document.createElement('div');
                div.className = `grid-item ${item.is_solved ? 'solved' : ''}`;
                div.id = `card-${item.location_id}`;
                div.innerHTML = `
                    <div class="loc-label">${item.location_id.toUpperCase()}</div>
                    <button class="mini-qr-btn" onclick="generateQR('${item.location_id}')">ğŸ“± QR</button>
                    <div class="item-icon">${item.icon}</div>
                    <div class="item-code">${item.code}</div>
                `;
                container.appendChild(div);
            });
        }

let currentChannel = null;

        function startListening() {
            // 1. å¦‚æœæœ‰èˆŠé »é“ï¼Œå…ˆç§»é™¤ï¼Œç¢ºä¿ä¹¾æ·¨
            if (currentChannel) {
                supabase.removeChannel(currentChannel);
            }

            console.log(`ğŸ“¡ å•Ÿå‹•ç›£è½... ç›®æ¨™ Session ID: ${activeSessionId}`);

            // 2. è¨‚é–±æ•´å€‹ mission_states è¡¨æ ¼ (ä¸è¨­ filter)
            currentChannel = supabase.channel('room-global')
            .on(
                'postgres_changes', 
                { 
                    event: 'UPDATE', 
                    schema: 'public', 
                    table: 'mission_states' 
                }, 
                (payload) => {
                    console.log("ğŸ“¨ æ”¶åˆ°è®Šæ›´è¨Šè™Ÿï¼", payload);

                    // 3. ã€é—œéµã€‘åœ¨é€™é‚Šè‡ªå·±æª¢æŸ¥ ID (å‰ç«¯éæ¿¾)
                    // å¦‚æœæ”¶åˆ°çš„è³‡æ–™ session_id ä¸ç­‰æ–¼ç•¶å‰æˆ°å±€ IDï¼Œå°±å¿½ç•¥
                    if (payload.new.session_id !== activeSessionId) {
                        console.log("Ignoring update from other session.");
                        return;
                    }

                    // 4. æ›´æ–°ç•«é¢
                    const updated = payload.new;
                    if (updated.is_solved) {
                        const card = document.getElementById(`card-${updated.location_id}`);
                        if (card) {
                            console.log(`âœ… å‘½ä¸­ï¼æ›´æ–°å¡ç‰‡: ${updated.location_id}`);
                            card.classList.add('solved');
                        }
                    }
                }
            )
            .subscribe((status) => {
                console.log(`ğŸ“¶ é€£ç·šç‹€æ…‹: ${status}`);
                if (status === 'SUBSCRIBED') {
                    console.log("ğŸš€ å³æ™‚ç›£æ§å·²é€£ç·šï¼ç¾åœ¨ä¸éœ€è¦ F5 äº†ï¼");
                }
            });
        }

        // On Load: Try to fetch latest active session
        window.onload = async () => {
             const { data: sessions } = await supabase.from('game_sessions').select('id').eq('is_active', true).order('created_at', { ascending: false }).limit(1);
             if(sessions && sessions.length > 0) {
                 activeSessionId = sessions[0].id;
                 const { data: missions } = await supabase.from('mission_states').select('*').eq('session_id', activeSessionId);
                 if(missions) {
                     renderDashboard(missions);
                     startListening();
                     document.getElementById('status-text').innerText = `RESUMED SESSION: ${activeSessionId.split('-')[0]}...`;
                 }
             }
        }
        function generateQR(locId) {
        // 1. è¨ˆç®— mission_v2.html çš„å®Œæ•´ç¶²å€
        // è‡ªå‹•æŠ“å–ç•¶å‰ç¶²å€è·¯å¾‘ï¼ŒæŠŠ hq_v2.html æ›æˆ mission_v2.html
        const baseUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/'));
        const fullUrl = `${baseUrl}/mission_v2.html?id=${locId}`;

        // 2. è¨­å®š UI
        document.getElementById('qrTitle').innerText = `SCAN TO ACCESS: ${locId.toUpperCase()}`;
        document.getElementById('qrLink').innerText = fullUrl;
        document.getElementById('qrLink').href = fullUrl;
        document.getElementById('qrCanvas').innerHTML = ""; // æ¸…ç©ºèˆŠåœ–

        // 3. ç”¢ç”Ÿ QR Code
        new QRCode(document.getElementById("qrCanvas"), {
            text: fullUrl,
            width: 250,
            height: 250,
            colorDark : "#000000",
            colorLight : "#ffffff",
            correctLevel : QRCode.CorrectLevel.H
        });

        // 4. é¡¯ç¤ºè¦–çª—
        document.getElementById('qrModal').style.display = 'flex';
    }

    function closeQR() {
        document.getElementById('qrModal').style.display = 'none';
    }
    function generateCodeBook() {
    // 1. æº–å‚™ HTML æ¨™é ­
    let html = `
        <html>
        <head>
            <title>é€šè¨Šä»£ç¢¼å°ç…§è¡¨ (Code Book)</title>
            <style>
                body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; }
                h1 { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; }
                .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 20px; }
                .item { border: 1px solid #ccc; padding: 5px 10px; display: flex; justify-content: space-between; align-items: center; }
                .name { font-weight: bold; font-size: 1.1rem; }
                .code { font-family: "Courier New", monospace; font-weight: bold; font-size: 1.2rem; background: #eee; padding: 2px 6px; border-radius: 4px; }
                @media print { .btn-print { display: none; } }
            </style>
        </head>
        <body>
            <h1>ğŸ“ æ©Ÿå¯†ä»»å‹™ï¼šé€šè¨Šä»£ç¢¼å°ç…§è¡¨</h1>
            <div style="text-align:center; margin-bottom:20px; color:#666;">
                âš ï¸ åƒ…ä¾›é€šè¨Šå®˜ä½¿ç”¨ï¼Œè«‹å¦¥å–„ä¿ç®¡ã€‚
            </div>
            <div class="grid">
    `;

    // 2. è®€å– FIXED_CODE_MAP ä¸¦ç”Ÿæˆè¡¨æ ¼
    // ç‚ºäº†ç¾è§€ï¼Œæˆ‘å€‘ä¾æ“šæ³¨éŸ³æˆ–ç­†ç•«ç¨å¾®æ’åºä¸€ä¸‹ (é€™è£¡ç°¡å–®ç”¨ key æ’åº)
    const sortedKeys = Object.keys(FIXED_CODE_MAP).sort();
    
    sortedKeys.forEach(key => {
        html += `
            <div class="item">
                <span class="name">${key}</span>
                <span class="code">${FIXED_CODE_MAP[key]}</span>
            </div>
        `;
    });

    // 3. çµå°¾
    html += `
            </div>
            <div style="margin-top:30px; text-align:center; font-size:0.8rem; color:#999;">
                GENERATED BY URBAN WATCHERS HQ SYSTEM
            </div>
            <script>window.print();<\/script>
        </body>
        </html>
    `;

    // 4. é–‹å•Ÿæ–°è¦–çª—åˆ—å°
    const printWin = window.open('', '_blank');
    printWin.document.write(html);
    printWin.document.close();
}    

    </script>
</body>
</html>
