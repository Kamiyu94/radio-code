<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HQ COMMAND CENTER (ONLINE)</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --bg: #000; --text: #0f0; --border: #333; --highlight: #00ff41; --danger: #ff3333; }
        body { background: var(--bg); color: var(--text); font-family: 'Consolas', monospace; margin: 0; padding: 20px; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* HEADER & CONTROLS */
        .header { border-bottom: 2px solid var(--border); padding-bottom: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; font-size: 1.5rem; letter-spacing: 2px; }
        
        .control-panel { background: #111; border: 1px solid var(--border); padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .mode-switch { display: flex; gap: 20px; margin-bottom: 15px; align-items: center; }
        .radio-label { cursor: pointer; display: flex; align-items: center; color: #fff; }
        .radio-label input { margin-right: 8px; transform: scale(1.5); }
        
        .btn { background: #222; color: var(--highlight); border: 1px solid var(--highlight); padding: 10px 20px; font-size: 1rem; cursor: pointer; text-transform: uppercase; font-weight: bold; width: 100%; transition: 0.2s; }
        .btn:hover { background: var(--highlight); color: #000; }
        .btn:active { transform: scale(0.98); }

        /* DASHBOARD GRID */
        .dashboard { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; flex: 1; overflow-y: auto; align-content: start; }
        .grid-item { border: 1px solid #444; background: #0a0a0a; border-radius: 8px; padding: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; min-height: 100px; }
        
        .grid-item.solved { background: rgba(0, 255, 65, 0.2); border-color: var(--highlight); box-shadow: 0 0 15px var(--highlight); }
        .grid-item.solved::after { content: 'CLEARED'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-15deg); color: var(--highlight); font-size: 1.5rem; font-weight: 900; border: 3px solid var(--highlight); padding: 5px; opacity: 0.8; pointer-events: none; }

        .loc-label { position: absolute; top: 5px; left: 5px; font-size: 0.7rem; color: #666; }
        .item-icon { font-size: 3rem; margin-bottom: 5px; }
        .item-code { font-size: 1.2rem; font-weight: bold; color: #fff; background: #222; padding: 2px 8px; border-radius: 4px; }
        
        /* STATUS BAR */
        .status-bar { margin-top: 10px; color: #888; font-size: 0.8rem; text-align: center; }
        
        /* LOADING OVERLAY */
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; justify-content:center; align-items:center; z-index:99; display:none;}
        /* QR Code Modal Styles */
        .qr-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 200; justify-content: center; align-items: center; flex-direction: column; }
        .qr-box { background: #111; border: 2px solid var(--highlight); padding: 30px; border-radius: 10px; text-align: center; max-width: 90%; }
        .qr-code-img { margin: 20px auto; border: 10px solid #fff; } /* ÁôΩÈÇäËÆì QR Êõ¥ÂÆπÊòìÊéÉ */
        .qr-link { color: var(--highlight); display: block; margin-top: 15px; text-decoration: underline; word-break: break-all; font-size: 0.9rem; }
        .close-btn { margin-top: 20px; background: var(--danger); color: #fff; border: none; padding: 10px 30px; font-size: 1.2rem; cursor: pointer; border-radius: 5px; }
        .mini-qr-btn { position: absolute; top: 5px; right: 5px; background: transparent; border: 1px solid #444; color: #666; cursor: pointer; padding: 2px 6px; font-size: 0.8rem; border-radius: 4px; z-index: 10; }
        .mini-qr-btn:hover { color: var(--highlight); border-color: var(--highlight); }
    </style>
</head>
<body>

    <div class="header">
        <h1>HQ MONITOR</h1>
        <div style="font-size:0.8rem; color:#666;">ONLINE VER.</div>
    </div>

    <div class="control-panel">
        <button class="btn" onclick="startNewGame()">‚ö† ÂàùÂßãÂåñ‰∏¶ÂïüÂãïÊñ∞Êà∞Â±Ä ‚ö†</button>
        <button class="btn" style="margin-top:10px; border-color:#fff; color:#fff;" onclick="generateCodeBook()">üñ®Ô∏è Áî¢Áîü/ÂàóÂç∞ ÂØÜÁ¢ºÂ∞çÁÖßË°® (Code Book)</button>
    </div>

    <div id="dashboard" class="dashboard">
        <div style="grid-column: 1/-1; text-align:center; color:#444; padding-top:50px;">
            Á≠âÂæÖÂïüÂãïÊà∞Â±Ä...
        </div>
    </div>

    <div class="status-bar" id="status-text">SYSTEM STANDBY</div>
    <div id="loading"><div style="color:#fff; font-size:2rem;">PROCESSING...</div></div>
    
    <div id="qrModal" class="qr-modal">
        <div class="qr-box">
            <h2 id="qrTitle" style="color:var(--highlight); margin-top:0;">LOC X</h2>
            <div id="qrCanvas"></div>
            <a id="qrLink" href="#" target="_blank" class="qr-link">LINK</a>
            <button class="close-btn" onclick="closeQR()">CLOSE WINDOW</button>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION (Ë´ãÂ°´ÂÖ•‰Ω†ÁöÑ Supabase Ë≥áÊñô) ---
        const SUPABASE_URL = 'https://lqhgpeuoejdyodanvauv.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxxaGdwZXVvZWpkeW9kYW52YXV2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1MDUyMzAsImV4cCI6MjA3OTA4MTIzMH0.my3U8mN06xm79ArFamTpWydf7rYFXOKT5-ooKmqb_O4';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- 2. ASSET DATA (ÂÆåÊï¥ÂõõÂ∞èÈöäË≥áÊñô) ---

        // (1) ÂÖ±ÈÄöÁâ©ÂìÅÊ∏ÖÂñÆÔºöÈÄôÊòØÂõõÂÄãÂ∞èÈöäÊõ∏Êú¨Ë£°ÈÉΩÊúâÁöÑÁâ©ÂìÅÔºåÁ¢∫‰øùÈÅäÊà≤È†ÜÊö¢
        const ITEMS_LIST = [
            // Ê∞¥ÊûúÈ°û (12Á®Æ)
            "Ëë°ËêÑ", "Ë•øÁìú", "Ê©òÂ≠ê", "Ê™∏Ê™¨", "ËòãÊûú", "Ê¢®Â≠ê", 
            "Ê§∞Â≠ê", "ËäíÊûú", "ÂìàÂØÜÁìú", "Áï™ËåÑ", "ËçâËéì", "È≥≥Ê¢®",
            // ÂãïÁâ©È°û (6Á®Æ)
            "ÁçÖÂ≠ê", "ËÄÅÈ∑π", "È±∑È≠ö", "Ë≤ìÈ†≠È∑π", "Èï∑È†∏Èπø", "Ë¢ãÈº†",
            // Ê§çÁâ©È°û (10Á®Æ)
            "ÂêëÊó•Ëëµ", "‰ªô‰∫∫Êéå", "Á´πÂ≠ê", "Êâ∂Ê°ëËä±", "Ê•ìËëâ", 
            "Ëñ∞Ë°£Ëçâ", "ËñÑËç∑", "ÊùæÊ®π", "ÈõõËèä", "Ë≤ùÊÆº"
        ];

        // (2) ÂØÜÁ¢ºÁ®ÆÂ≠êÔºöÂ∑≤ÂåÖÂê´ A, B, C, D ÂõõÂ∞èÈöäÂÆåÊï¥ÂØÜÁ¢º
        const SEEDS = {
            // Alpha Team (A)
            A: [
                "L2Z5", "P8K3", "S4M1", "T4W7", "X4T9", "Q4Y9", 
                "B1D6", "K7X1", "V2C5", "O6A4", "U9E2", "Z3N7",
                "C7M1", "D5S2", "X2U5", "R9S6", "N3Y0", "G6P9",
                "G2V4", "B8H7", "L6P2", "F5G8", "Z7D5", 
                "K3I6", "E2A4", "J3R6", "C6U3", "P8M5"
            ],
            // Bravo Team (B)
            B: [
                "L3T6", "D8M3", "Z8A4", "W5Y3", "C5K1", "B2H9",
                "I1R8", "J9S0", "D1E5", "B6C9", "G7Q5", "U6Q4",
                "P5Q9", "B2C8", "H9I2", "D7E1", "W6X3", "U4V0",
                "F3G8", "H5I0", "U7V1", "L6N3", "Z7D5",
                "Z5A3", "B9C4", "O8P2", "W2Y6", "D1E8"
            ],
            // Charlie Team (C)
            C: [
                "G5H0", "K1L9", "M6N4", "C9D1", "Q0R2", "A4B7",
                "E2F6", "U7V9", "I8J3", "W2X5", "V1G5", "O3P7",
                "C2D8", "L0M9", "N4O6", "T5U0", "V9W3", "D0E5",
                "L2M7", "J6K8", "A3B6", "H1I5", "D0E4",
                "V1W6", "A9B3", "F9G2", "X7Z2", "C0D5"
            ],
            // Delta Team (D)
            D: [
                "G6I4", "L1M7", "W7Z1", "P9R3", "C8D0", "Q4Y9",
                "C2D6", "K7X1", "U0V6", "E8F3", "N5O2", "S4T8",
                "C9E4", "U8V3", "M4N9", "W5X0", "S1T7", "C6D2",
                "O3P5", "Q8R1", "S2T6", "F5G8", "U7V4",
                "Z9A3", "D1E6", "L4M9", "B8C2", "F5G0"
            ]
        };

        // (3) Ëá™ÂãïÁîüÊàêÂØÜÁ¢ºÂ∞çÁÖßË°® (CODE_BOOKS)
        const CODE_BOOKS = { 'A': {}, 'B': {}, 'C': {}, 'D': {} };
        ITEMS_LIST.forEach((item, index) => {
            if(index < SEEDS.A.length) CODE_BOOKS.A[item] = SEEDS.A[index];
            if(index < SEEDS.B.length) CODE_BOOKS.B[item] = SEEDS.B[index];
            if(index < SEEDS.C.length) CODE_BOOKS.C[item] = SEEDS.C[index];
            if(index < SEEDS.D.length) CODE_BOOKS.D[item] = SEEDS.D[index];
        });

        // (4) ÈÅäÊà≤Ë≥áÁî¢ (MASTER_ASSETS) - ÂÉÖÂåÖÂê´ÂÆâÂÖ®ÂêçÂñÆÂÖßÁöÑÁâ©ÂìÅ
        const MASTER_ASSETS = {
            fruits: [
                {n:"Ëë°ËêÑ", i:"üçá"}, {n:"Ë•øÁìú", i:"üçâ"}, {n:"Ê©òÂ≠ê", i:"üçä"}, {n:"Ê™∏Ê™¨", i:"üçã"},
                {n:"ËòãÊûú", i:"üçé"}, {n:"Ê¢®Â≠ê", i:"üçê"}, {n:"Ê§∞Â≠ê", i:"ü••"}, {n:"ËäíÊûú", i:"ü•≠"},
                {n:"ÂìàÂØÜÁìú", i:"üçà"}, {n:"Áï™ËåÑ", i:"üçÖ"}, {n:"ËçâËéì", i:"üçì"}, {n:"È≥≥Ê¢®", i:"üçç"}
            ],
            animals: [
                {n:"ÁçÖÂ≠ê", i:"ü¶Å"}, {n:"ËÄÅÈ∑π", i:"ü¶Ö"}, {n:"È±∑È≠ö", i:"üêä"},
                {n:"Ë≤ìÈ†≠È∑π", i:"ü¶â"}, {n:"Èï∑È†∏Èπø", i:"ü¶í"}, {n:"Ë¢ãÈº†", i:"ü¶ò"}
            ],
            plants: [
                {n:"ÂêëÊó•Ëëµ", i:"üåª"}, {n:"‰ªô‰∫∫Êéå", i:"üåµ"}, {n:"Á´πÂ≠ê", i:"üéã"}, {n:"Êâ∂Ê°ëËä±", i:"üå∫"},
                {n:"Ê•ìËëâ", i:"üçÅ"}, {n:"Ëñ∞Ë°£Ëçâ", i:"üíê"}, {n:"ËñÑËç∑", i:"üåø"}, {n:"ÊùæÊ®π", i:"üå≤"},
                {n:"ÈõõËèä", i:"üåº"}, {n:"Ë≤ùÊÆº", i:"üêö"}
            ]
        };

        // --- 3. LOGIC HELPERS ---

        // 1. Ê¥óÁâåÊºîÁÆóÊ≥ï (Fisher-Yates Shuffle)
        function shuffle(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex != 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [
                    array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        // 2. Èö®Ê©ü‰ª£Á¢ºÁî¢ÁîüÂô® (Fallback Áî®)
        function generateRandomCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let result = '';
            for (let i = 0; i < 4; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // --- 4. CORE FUNCTIONS ---

        async function startNewGame() {
            if(!confirm("‚ö†Ô∏è Á¢∫ÂÆöË¶ÅÂïüÂãïÊñ∞Êà∞Â±ÄÔºü\nÈÄôÂ∞áÊúÉÈáçÁΩÆÁõÆÂâçÊâÄÊúâÁöÑÈÄ£Á∑öÈÄ≤Â∫¶ÔºÅ")) return;
            
            document.getElementById('loading').style.display = 'flex';
            
            // --- 1. Create Session ---
            const { data: session, error: sessionError } = await supabase.from('game_sessions').insert([{ is_active: true }]).select().single();
            
            if(sessionError) { 
                document.getElementById('loading').style.display = 'none';
                alert(`ERROR: ÁÑ°Ê≥ïÂâµÂª∫Êà∞Â±ÄÔºÅ\n${sessionError.message}`); 
                console.error(sessionError); 
                return; 
            }
            
            activeSessionId = session.id;

            // --- 2. Prepare Data (Shuffle Items) ---
            const shuffledFruits = shuffle([...MASTER_ASSETS.fruits]);
            const shuffledAnimals = shuffle([...MASTER_ASSETS.animals]);
            const shuffledPlants = shuffle([...MASTER_ASSETS.plants]);

            const missions = [
                // Phase 1 (Fruits)
                { id: 'loc_1', cat: 'fruits', hint: 'ÂâçÂæÄ LOC 5', comm: 'ÂëºÂè´ B Â∞èÈöä(CH2)', target_book: 'B' }, 
                { id: 'loc_2', cat: 'fruits', hint: 'ÂâçÂæÄ LOC 7', comm: 'ÂëºÂè´ A Â∞èÈöä(CH1)', target_book: 'A' }, 
                { id: 'loc_3', cat: 'fruits', hint: 'ÂâçÂæÄ LOC 6', comm: 'ÂëºÂè´ D Â∞èÈöä(CH4)', target_book: 'D' }, 
                { id: 'loc_4', cat: 'fruits', hint: 'ÂâçÂæÄ LOC 8', comm: 'ÂëºÂè´ C Â∞èÈöä(CH3)', target_book: 'C' }, 
                // Phase 2 (Animals)
                { id: 'loc_5', cat: 'animals', hint: 'ÂâçÂæÄ LOC 9',  comm: 'ÂëºÂè´ C Â∞èÈöä(CH3)', target_book: 'C' },
                { id: 'loc_6', cat: 'animals', hint: 'ÂâçÂæÄ LOC 11', comm: 'ÂëºÂè´ D Â∞èÈöä(CH4)', target_book: 'D' },
                { id: 'loc_7', cat: 'animals', hint: 'ÂâçÂæÄ LOC 10', comm: 'ÂëºÂè´ A Â∞èÈöä(CH1)', target_book: 'A' },
                { id: 'loc_8', cat: 'animals', hint: 'ÂâçÂæÄ LOC 12', comm: 'ÂëºÂè´ B Â∞èÈöä(CH2)', target_book: 'B' },
                // Phase 3 (Plants)
                { id: 'loc_9',  cat: 'plants', hint: 'MISSION COMPLETE', comm: 'ÂõûÂ†± HQ', target_book: 'B' },
                { id: 'loc_10', cat: 'plants', hint: 'MISSION COMPLETE', comm: 'ÂõûÂ†± HQ', target_book: 'A' },
                { id: 'loc_11', cat: 'plants', hint: 'MISSION COMPLETE', comm: 'ÂõûÂ†± HQ', target_book: 'D' },
                { id: 'loc_12', cat: 'plants', hint: 'MISSION COMPLETE', comm: 'ÂõûÂ†± HQ', target_book: 'C' }
            ];

            const payload = missions.map((m, idx) => {
                let asset;
                if(m.cat === 'fruits') asset = shuffledFruits.pop();
                else if(m.cat === 'animals') asset = shuffledAnimals.pop();
                else asset = shuffledPlants.pop();

                // ‚òÖ Âº∑Âà∂‰ΩøÁî®ÂØÜÁ¢ºÊú¨
                let code = CODE_BOOKS[m.target_book][asset.n];
                
                if(!code) {
                    console.error(`Missing code for ${asset.n} in Book ${m.target_book}`);
                    code = generateRandomCode(); 
                }

                return {
                    session_id: activeSessionId,
                    location_id: m.id,
                    name: asset.n,
                    icon: asset.i,
                    code: code,
                    category: m.cat,
                    next_hint: m.hint,
                    comm_msg: m.comm
                };
            });

            // --- 3. Upload ---
            const { error: missionError } = await supabase.from('mission_states').insert(payload);
            
            if(missionError) {
                document.getElementById('loading').style.display = 'none';
                alert(`ERROR: ÁÑ°Ê≥ï‰∏äÂÇ≥‰ªªÂãôÔºÅ\n${missionError.message}`);
                console.error(missionError);
                return;
            }
            
            // --- 4. Finish ---
            document.getElementById('loading').style.display = 'none';
            document.getElementById('status-text').innerText = `SESSION ACTIVE: ${activeSessionId.split('-')[0]}...`;
            
            renderDashboard(payload);
            startListening();
        }

        function renderDashboard(data) {
            const container = document.getElementById('dashboard');
            container.innerHTML = '';
            
            const order = ['loc_1','loc_2','loc_3','loc_4','loc_5','loc_6','loc_7','loc_8','loc_9','loc_10','loc_11','loc_12'];
            
            data.sort((a,b) => order.indexOf(a.location_id) - order.indexOf(b.location_id));

            data.forEach(item => {
                const div = document.createElement('div');
                div.className = `grid-item ${item.is_solved ? 'solved' : ''}`;
                div.id = `card-${item.location_id}`;
                div.innerHTML = `
                    <div class="loc-label">${item.location_id.toUpperCase()}</div>
                    <button class="mini-qr-btn" onclick="generateQR('${item.location_id}')">üì± QR</button>
                    <div class="item-icon">${item.icon}</div>
                    <div class="item-code">${item.code}</div>
                `;
                container.appendChild(div);
            });
        }

        let currentChannel = null;

        function startListening() {
            if (currentChannel) {
                supabase.removeChannel(currentChannel);
            }

            console.log(`üì° ÂïüÂãïÁõ£ËÅΩ... ÁõÆÊ®ô Session ID: ${activeSessionId}`);

            currentChannel = supabase.channel('room-global')
            .on(
                'postgres_changes', 
                { 
                    event: 'UPDATE', 
                    schema: 'public', 
                    table: 'mission_states' 
                }, 
                (payload) => {
                    console.log("üì® Êî∂Âà∞ËÆäÊõ¥Ë®äËôüÔºÅ", payload);

                    if (payload.new.session_id !== activeSessionId) {
                        console.log("Ignoring update from other session.");
                        return;
                    }

                    const updated = payload.new;
                    if (updated.is_solved) {
                        const card = document.getElementById(`card-${updated.location_id}`);
                        if (card) {
                            console.log(`‚úÖ ÂëΩ‰∏≠ÔºÅÊõ¥Êñ∞Âç°Áâá: ${updated.location_id}`);
                            card.classList.add('solved');
                        }
                    }
                }
            )
            .subscribe((status) => {
                console.log(`üì∂ ÈÄ£Á∑öÁãÄÊÖã: ${status}`);
                if (status === 'SUBSCRIBED') {
                    console.log("üöÄ Âç≥ÊôÇÁõ£ÊéßÂ∑≤ÈÄ£Á∑öÔºÅÁèæÂú®‰∏çÈúÄË¶Å F5 ‰∫ÜÔºÅ");
                }
            });
        }

        // On Load
        window.onload = async () => {
             const { data: sessions } = await supabase.from('game_sessions').select('id').eq('is_active', true).order('created_at', { ascending: false }).limit(1);
             if(sessions && sessions.length > 0) {
                 activeSessionId = sessions[0].id;
                 const { data: missions } = await supabase.from('mission_states').select('*').eq('session_id', activeSessionId);
                 if(missions) {
                     renderDashboard(missions);
                     startListening();
                     document.getElementById('status-text').innerText = `RESUMED SESSION: ${activeSessionId.split('-')[0]}...`;
                 }
             }
        }

        function generateQR(locId) {
            const baseUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/'));
            const fullUrl = `${baseUrl}/mission_v2.html?id=${locId}`;

            document.getElementById('qrTitle').innerText = `SCAN TO ACCESS: ${locId.toUpperCase()}`;
            document.getElementById('qrLink').innerText = fullUrl;
            document.getElementById('qrLink').href = fullUrl;
            document.getElementById('qrCanvas').innerHTML = "";

            new QRCode(document.getElementById("qrCanvas"), {
                text: fullUrl,
                width: 250,
                height: 250,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });

            document.getElementById('qrModal').style.display = 'flex';
        }

        function closeQR() {
            document.getElementById('qrModal').style.display = 'none';
        }

        // --- 5. PRINT FUNCTION (‰øÆÊ≠£ÁâàÔºöÁµ±‰∏ÄË£ÅÂàáÁ∑öÈ°èËâ≤) ---
        function generateCodeBook() {
            // 1. Ê∫ñÂÇôÂúñÁ§∫Â∞çÁÖßË°®
            const iconMap = {};
            Object.values(MASTER_ASSETS).forEach(category => {
                category.forEach(item => {
                    iconMap[item.n] = item.i;
                });
            });

            // 2. Ë®≠ÂÆöÂàóÂç∞Ê®£Âºè
            let html = `<html><head><title>MISSION CODE BOOKS (GRID VIEW)</title><style>
                @page { size: A4; margin: 0; }
                
                body { 
                    font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; 
                    -webkit-print-color-adjust: exact; 
                    margin: 0; padding: 10mm; 
                    height: 100vh; 
                    box-sizing: border-box;
                    display: flex; 
                    flex-wrap: wrap; 
                    justify-content: space-between;
                    align-content: space-between;
                }
                
                .quarter-page { 
                    width: calc(50% - 2mm); 
                    height: calc(50% - 2mm); 
                    border: 1px dashed #666; /* ‚òÖ ‰øÆÊîπÈÄôË£°ÔºöÁµ±‰∏ÄÁî®Ê∑±ÁÅ∞Ëâ≤ÔºåÁ¢∫‰øùÁúãÂæóÊ∏ÖÊ•ö */
                    box-sizing: border-box; 
                    padding: 8px;
                    position: relative;
                    display: flex;
                    flex-direction: column;
                    border-radius: 8px;
                    overflow: hidden; 
                }

                .header-section {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    border-bottom: 2px solid #000;
                    padding-bottom: 4px;
                    margin-bottom: 4px;
                    height: 35px;
                }

                .team-name { 
                    font-size: 1.2rem; font-weight: 900; color: #fff; 
                    padding: 2px 12px; border-radius: 4px; 
                    text-shadow: 1px 1px 0px rgba(0,0,0,0.5);
                }
                
                .warning { 
                    font-size: 0.6rem; color: #666; font-weight: bold;
                    text-align: right; line-height: 1.1;
                }

                .grid-container { 
                    display: grid; 
                    grid-template-columns: repeat(4, 1fr); 
                    grid-template-rows: repeat(7, 1fr);    
                    gap: 2px;
                    flex: 1; 
                }

                .item { 
                    border: 1px solid #ddd; 
                    border-radius: 4px;
                    display: flex; 
                    flex-direction: column; 
                    justify-content: center; 
                    align-items: center; 
                    text-align: center;
                    background: rgba(255,255,255,0.8);
                }
                
                .item-top { font-size: 0.75rem; line-height: 1; margin-bottom: 2px; white-space: nowrap; }
                .item-icon { font-size: 0.9rem; margin-right: 2px; }
                .item-name { font-weight: bold; }
                
                .item-code { 
                    font-family: 'Consolas', monospace; 
                    font-weight: 900; 
                    font-size: 1rem; 
                    color: #000;
                    line-height: 1;
                    letter-spacing: -0.5px;
                }
                
                .watermark {
                    position: absolute; top: 55%; left: 50%; 
                    transform: translate(-50%, -50%) rotate(0deg);
                    font-size: 8rem; opacity: 0.04; 
                    font-weight: 900; pointer-events: none; 
                    z-index: 0; color: #000;
                }

                .footer {
                    font-size: 0.5rem; text-align: center; margin-top: 4px; color: #aaa; height: 10px;
                }

                /* ‚òÖ ÊàëÊääÂéüÊú¨ÈÄôÈÇä„ÄåÊîπËÆäÈÇäÊ°ÜÈ°èËâ≤„ÄçÁöÑÁ®ãÂºèÁ¢ºÂà™Êéâ‰∫ÜÔºåÈÄôÊ®£ D Â∞èÈöäÂ∞±‰∏çÊúÉËÆäÊàêÁúã‰∏çË¶ãÁöÑÈªÉËâ≤ÈÇäÊ°Ü‰∫Ü */
                
            </style></head><body>`;

            const teams = ['A', 'B', 'C', 'D'];
            const teamInfo = {
                'A': { name: 'ALPHA', color: '#CC0000' },
                'B': { name: 'BRAVO', color: '#009900' },
                'C': { name: 'CHARLIE', color: '#0033CC' },
                'D': { name: 'DELTA', color: '#CCAA00' }
            };

            teams.forEach(team => {
                const bookData = CODE_BOOKS[team];
                if (!bookData) return;
                const info = teamInfo[team];

                html += `
                <div class="quarter-page" data-team="${team}">
                    <div class="watermark">${team}</div>
                    
                    <div class="header-section">
                        <div class="team-name" style="background:${info.color}">${info.name}</div>
                        <div class="warning">CONFIDENTIAL<br>EYES ONLY</div>
                    </div>
                    
                    <div class="grid-container">`;
                
                Object.keys(bookData).sort().forEach(itemName => {
                    const icon = iconMap[itemName] || ''; 
                    html += `
                    <div class="item">
                        <div class="item-top">
                            <span class="item-icon">${icon}</span>
                            <span class="item-name">${itemName}</span>
                        </div>
                        <div class="item-code">${bookData[itemName]}</div>
                    </div>`;
                });

                html += `
                    </div>
                    <div class="footer">CITY GUARDIAN TACTICAL - ${info.name} SQUAD</div>
                </div>`;
            });

            html += `<script>window.print();<\/script></body></html>`;
            
            const printWin = window.open('', '_blank');
            printWin.document.write(html);
            printWin.document.close();
        }    
    </script>
</body>
</html>
