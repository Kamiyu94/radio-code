<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>FIELD TERMINAL (OFFLINE)</title>
    <style>
        :root {
            --bg-color: #000000;
            --text-main: #e0e0e0;
            --highlight: #00ff41;
            --danger: #ff3333;
            --warning: #ffcc00;
            --cool: #00ffff;
            --panel-bg: #111111;
            --border: #333;
            --alpha: #ff3333;
            --bravo: #33cc33;
            --charlie: #3388ff;
            --delta: #ffff33;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-variant-numeric: slashed-zero;
            margin: 0;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .hidden { display: none !important; }
        
        /* é€šç”¨è¢å¹•å®¹å™¨ */
        .screen { 
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            padding: 20px; padding-top: 5vh; width: 100%; height: 100%; position: absolute; top: 0; left: 0;
            background: #000; z-index: 10; overflow-y: auto;
        }

        h1, h2 { text-transform: uppercase; letter-spacing: 2px; text-align: center; margin-bottom: 20px; color: var(--highlight); }
        h2 { font-size: 1.2rem; margin-bottom: 15px; }

        /* --- æ–°ç‰ˆé¦–é ï¼šå°éšŠé¸æ“‡é¸å–® --- */
        #squad-menu { z-index: 5; justify-content: center; padding-top: 20px; }
        .menu-btn {
            width: 100%; max-width: 320px; padding: 25px; margin-bottom: 20px;
            font-size: 1.5rem; font-weight: 900; border-radius: 12px;
            background: #111; color: #fff; border: 3px solid #333;
            text-align: left; position: relative; cursor: pointer; transition: 0.2s;
            display: flex; justify-content: space-between; align-items: center;
        }
        .menu-btn:active { transform: scale(0.97); filter: brightness(1.2); }
        .menu-btn::after { content: 'ğŸ““'; font-size: 1.8rem; }

        /* --- æ–°ç‰ˆé é¢ï¼šå¯†ç¢¼æœ¬æª¢è¦– --- */
        #codebook-view { z-index: 6; background: #050505; }
        .book-header { 
            width: 100%; padding: 15px; text-align: center; font-size: 1.5rem; font-weight: 900; 
            color: #fff; margin-bottom: 20px; border-radius: 8px; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }
        
        .book-category-title {
            width: 100%; max-width: 350px;
            color: #666; font-size: 0.8rem; margin-top: 15px; margin-bottom: 5px; border-bottom: 1px solid #333; padding-bottom: 2px;
        }

        .book-grid {
            display: grid; grid-template-columns: 1fr auto; gap: 8px;
            width: 100%; max-width: 350px; margin-bottom: 10px;
        }
        
        .book-item-col {
            display: flex; align-items: center; padding: 10px;
            background: rgba(255,255,255,0.05); border-radius: 6px 0 0 6px; font-size: 1rem;
        }
        .book-icon { font-size: 1.5rem; margin-right: 12px; }

        .book-code-col {
            display: flex; align-items: center; justify-content: center; padding: 10px; min-width: 100px;
            background: rgba(0,0,0,0.3); border: 1px solid var(--highlight); border-radius: 0 6px 6px 0;
            font-family: 'Consolas', monospace; font-size: 1.2rem; font-weight: 900; color: var(--highlight); letter-spacing: 1px;
        }

        .back-btn { margin-top: 30px; margin-bottom: 30px; background: #333; color: #ccc; border: none; }

        /* --- èˆŠæœ‰ä»»å‹™ä»‹é¢å…ƒä»¶ --- */
        .input-box {
            background: #000; border: 2px solid var(--highlight); color: var(--highlight);
            font-size: 2rem; padding: 15px; width: 100%; max-width: 300px; text-align: center;
            border-radius: 8px; margin-bottom: 20px; outline: none; font-family: inherit; text-transform: uppercase; user-select: text;
        }
        .btn {
            background: var(--panel-bg); border: 1px solid var(--highlight); color: var(--highlight);
            padding: 15px 30px; font-size: 1.2rem; border-radius: 8px; cursor: pointer;
            text-transform: uppercase; font-weight: bold; width: 100%; max-width: 300px; margin-bottom: 15px; transition: all 0.2s; flex-shrink: 0; 
        }
        .btn:active { background: var(--highlight); color: #000; transform: scale(0.98); }
        
        /* --- ä»»å‹™ç‹€æ…‹ç•«é¢ --- */
        #screen-pin { padding-top: 15vh; }
        .target-icon { font-size: 6rem; margin-bottom: 10px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.05);} 100% {transform: scale(1);} }
        .mission-hint { color: #888; font-size: 0.9rem; text-align: center; margin-bottom: 30px; max-width: 80%; }
        .attempts-left { color: var(--danger); margin-top: 10px; font-size: 0.9rem; }

        #screen-locked { background: #200000; border: 5px solid red; z-index: 20; justify-content: center; padding-top: 20px; }
        .lock-icon { font-size: 5rem; color: red; margin-bottom: 20px; cursor: pointer; }
        .lock-msg { color: red; font-size: 1.5rem; font-weight: bold; text-align: center; line-height: 1.5; }
        
        /* SUCCESS SCREEN */
        #screen-success { background: #001a00; z-index: 20; text-align: center; padding-top: 5vh; }
        .success-icon { font-size: 5rem; color: var(--highlight); margin-bottom: 20px; }
        .success-title { color: var(--highlight); font-size: 1.5rem; font-weight: bold; margin-bottom: 20px; }
        .next-step-box { border: 1px dashed var(--highlight); padding: 15px; border-radius: 8px; background: rgba(0, 255, 65, 0.1); margin-bottom: 10px; width: 100%; max-width: 320px; }
        .step-label { color: #888; font-size: 0.8rem; display: block; margin-bottom: 5px; }
        .step-val { color: #fff; font-size: 1.1rem; font-weight: bold; display: block; line-height: 1.4; }
        .comm-val { color: #ffcc00; font-size: 1rem; font-weight: bold; display: block; line-height: 1.4; white-space: pre-line; }

        #screen-cooldown { background: #0a0a0a; z-index: 15; border-top: 5px solid var(--cool); justify-content: center; padding-top: 20px; }
        .cool-icon { font-size: 5rem; margin-bottom: 20px; filter: grayscale(100%); opacity: 0.5; }
        .cool-msg { color: var(--cool); font-size: 1.2rem; font-weight: bold; text-align: center; margin-bottom: 40px; line-height: 1.5; }
        .reboot-btn { border-color: var(--cool); color: var(--cool); font-size: 1rem; padding: 10px; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
    </style>
</head>
<body>

    <div id="squad-menu" class="screen">
        <h1>CODE BOOK ACCESS</h1>
        <p style="color:#666; margin-bottom:30px;">OFFLINE DATABASE</p>
        <p style="color:#888; font-size:0.8rem; margin-bottom:20px;">è«‹é¸æ“‡æ‚¨æ‰€å±¬çš„å°éšŠä»¥æŸ¥çœ‹å¯†ç¢¼æœ¬</p>
        
        <div class="menu-btn" style="border-color:var(--alpha); color:var(--alpha);" onclick="showCodeBook('A')">ALPHA SQUAD</div>
        <div class="menu-btn" style="border-color:var(--bravo); color:var(--bravo);" onclick="showCodeBook('B')">BRAVO SQUAD</div>
        <div class="menu-btn" style="border-color:var(--charlie); color:var(--charlie);" onclick="showCodeBook('C')">CHARLIE SQUAD</div>
        <div class="menu-btn" style="border-color:var(--delta); color:var(--delta);" onclick="showCodeBook('D')">DELTA SQUAD</div>
    </div>

    <div id="codebook-view" class="screen hidden">
        <div id="book-header" class="book-header">SQUAD BOOK</div>
        <p style="color:#666; font-size:0.8rem; margin-bottom:20px;">CONFIDENTIAL // EYES ONLY</p>
        
        <div id="book-content-area" style="width:100%; display:flex; flex-direction:column; align-items:center;"></div>

        <button class="btn back-btn" onclick="showScreen('squad-menu')">â† BACK TO MENU</button>
    </div>

    <div id="screen-pin" class="screen hidden">
        <h2>TERMINAL ACCESS</h2>
        <p style="color:#666; margin-bottom:20px;">SECURITY CLEARANCE REQUIRED</p>
        <input type="number" id="pin-input" class="input-box" placeholder="PIN CODE">
        <button class="btn" onclick="checkPin()">ENTER</button>
    </div>

    <div id="screen-mission" class="screen hidden">
        <div style="text-align:right; width:100%; padding:10px; color:#444; font-size:0.8rem;">SECURE CONNECTION</div>
        <div id="target-display" class="target-icon">â“</div>
        <div id="target-name" style="font-size:1.5rem; font-weight:bold; margin-bottom:5px;">TARGET</div>
        <p class="mission-hint">å‘å‹è»å–®ä½ç´¢å–è§£é–ä»£ç¢¼<br>REQUEST CODE FROM ALLY</p>
        <input type="text" id="mission-input" class="input-box" placeholder="CODE" maxlength="10">
        <button class="btn" onclick="verifyCode()">VERIFY CODE</button>
        <div id="attempts-display" class="attempts-left hidden">âš  å¯†ç¢¼éŒ¯èª¤ (å‰©é¤˜ 2 æ¬¡æ©Ÿæœƒ)</div>
    </div>

    <div id="screen-locked" class="screen hidden">
        <div class="lock-icon" onclick="unlockTap()">âŒ</div>
        <div class="lock-msg">SYSTEM LOCKED<br>CONNECTION TERMINATED<br><br>PLEASE CONTACT HQ</div>
    </div>

    <div id="screen-success" class="screen hidden">
        <div class="success-icon">âœ…</div>
        <div class="success-title">ACCESS GRANTED</div>
        <div class="next-step-box">
            <span class="step-label">NEXT LOCATION (ä¸‹ä¸€ç«™)</span>
            <span id="success-next-loc" class="step-val">...</span>
        </div>
        <div class="next-step-box">
            <span class="step-label">COMM PROTOCOL (é€šè¨ŠæŒ‡ä»¤)</span>
            <span id="success-comm-msg" class="comm-val">...</span>
        </div>
        <p style="color:#666; font-size:0.8rem; margin-top:20px;">TERMINAL WILL SHUT DOWN</p>
    </div>

    <div id="screen-cooldown" class="screen hidden">
        <div class="cool-icon">ğŸ”‹</div>
        <div class="cool-msg">TERMINAL DISCHARGED<br>DATA UPLOAD COMPLETE<br><br>è«‹æ›´æ›è£ç½®é€²è¡Œä»»å‹™<br>SWITCH TO ANOTHER DEVICE</div>
        <button class="btn reboot-btn" onclick="showRebootModal()">SYSTEM REBOOT</button>
    </div>

    <div id="rescue-modal" class="modal-overlay hidden">
        <h2 style="color:red;">OVERRIDE LOCK</h2>
        <input type="number" id="rescue-input" class="input-box" placeholder="RESCUE CODE">
        <button class="btn" style="border-color:red; color:red;" onclick="attemptRescue()">UNLOCK</button>
        <button class="btn" style="border-color:#666; color:#666;" onclick="document.getElementById('rescue-modal').classList.add('hidden')">CANCEL</button>
    </div>

    <div id="reboot-modal" class="modal-overlay hidden">
        <h2 style="color:var(--cool);">SYSTEM REBOOT</h2>
        <input type="number" id="reboot-input" class="input-box" placeholder="ADMIN PIN">
        <button class="btn" style="border-color:var(--cool); color:var(--cool);" onclick="attemptReboot()">REBOOT</button>
        <button class="btn" style="border-color:#666; color:#666;" onclick="document.getElementById('reboot-modal').classList.add('hidden')">CANCEL</button>
    </div>

    <script>
        // --- 1. å®Œæ•´é›¢ç·šæ•¸æ“šåº« (FULL DATABASE) ---
        // é€™äº›è³‡æ–™å¿…é ˆè·Ÿ HQ ç«¯ä¸€æ¨¡ä¸€æ¨£ï¼Œæ‰èƒ½ç•¶ä½œæŸ¥è©¢ä½¿ç”¨
        const MASTER_ASSETS = {
            fruits: [{n:"è‘¡è„", i:"ğŸ‡"}, {n:"è¥¿ç“œ", i:"ğŸ‰"}, {n:"æ©˜å­", i:"ğŸŠ"}, {n:"æª¸æª¬", i:"ğŸ‹"}, {n:"è˜‹æœ", i:"ğŸ"}, {n:"æ¢¨å­", i:"ğŸ"}, {n:"æ¤°å­", i:"ğŸ¥¥"}, {n:"èŠ’æœ", i:"ğŸ¥­"}, {n:"å“ˆå¯†ç“œ", i:"ğŸˆ"}, {n:"ç•ªèŒ„", i:"ğŸ…"}, {n:"è‰è“", i:"ğŸ“"}, {n:"é³³æ¢¨", i:"ğŸ"}],
            animals: [{n:"ç…å­", i:"ğŸ¦"}, {n:"è€é·¹", i:"ğŸ¦…"}, {n:"é±·é­š", i:"ğŸŠ"}, {n:"è²“é ­é·¹", i:"ğŸ¦‰"}, {n:"é•·é ¸é¹¿", i:"ğŸ¦’"}, {n:"è¢‹é¼ ", i:"ğŸ¦˜"}],
            plants: [{n:"å‘æ—¥è‘µ", i:"ğŸŒ»"}, {n:"ä»™äººæŒ", i:"ğŸŒµ"}, {n:"ç«¹å­", i:"ğŸ‹"}, {n:"æ‰¶æ¡‘èŠ±", i:"ğŸŒº"}, {n:"æ¥“è‘‰", i:"ğŸ"}, {n:"è–°è¡£è‰", i:"ğŸ’"}, {n:"è–„è·", i:"ğŸŒ¿"}, {n:"æ¾æ¨¹", i:"ğŸŒ²"}, {n:"é››èŠ", i:"ğŸŒ¼"}, {n:"è²æ®¼", i:"ğŸš"}]
        };

        const TEAM_SEEDS = {
            A: ["L2Z5", "P8K3", "S4M1", "T4W7", "X4T9", "Q4Y9", "B1D6", "K7X1", "V2C5", "O6A4", "U9E2", "Z3N7", "C7M1", "D5S2", "X2U5", "R9S6", "N3Y0", "G6P9", "G2V4", "B8H7", "L6P2", "F5G8", "Z7D5", "K3I6", "E2A4", "J3R6", "C6U3", "P8M5"],
            B: ["L3T6", "D8M3", "Z8A4", "W5Y3", "C5K1", "B2H9", "I1R8", "J9S0", "D1E5", "B6C9", "G7Q5", "U6Q4", "P5Q9", "B2C8", "H9I2", "D7E1", "W6X3", "U4V0", "F3G8", "H5I0", "U7V1", "L6N3", "Z7D5", "Z5A3", "B9C4", "O8P2", "W2Y6", "D1E8"],
            C: ["G5H0", "K1L9", "M6N4", "C9D1", "Q0R2", "A4B7", "E2F6", "U7V9", "I8J3", "W2X5", "V1G5", "O3P7", "C2D8", "L0M9", "N4O6", "T5U0", "V9W3", "D0E5", "L2M7", "J6K8", "A3B6", "H1I5", "D0E4", "V1W6", "A9B3", "F9G2", "X7Z2", "C0D5"],
            D: ["G6I4", "L1M7", "W7Z1", "P9R3", "C8D0", "Q4Y9", "C2D6", "K7X1", "U0V6", "E8F3", "N5O2", "S4T8", "C9E4", "U8V3", "M4N9", "W5X0", "S1T7", "C6D2", "O3P5", "Q8R1", "S2T6", "F5G8", "U7V4", "Z9A3", "D1E6", "L4M9", "B8C2", "F5G0"]
        };

        // æ‰å¹³åŒ–çš„ç‰©å“æ¸…å–®ï¼Œç”¨æ–¼å°æ‡‰ Index
        const ITEMS_FLAT = [
            ...MASTER_ASSETS.fruits,
            ...MASTER_ASSETS.animals,
            ...MASTER_ASSETS.plants
        ];

        // --- 2. ä»»å‹™è³‡æ–™ (Mission Data) ---
        const missions = {
            'loc_1': { i: 'ğŸŒ', n: 'é¦™è•‰', c: 'A3O7', cat: 'fruits', next: 'å‰å¾€ LOC 5', comm: 'åˆ‡æ›è‡³ [ä¸»é » CH1 / å‚™é » CH3]ã€‚\nåˆ‡æ›å¾Œï¼Œè«‹å‘¼å«è©²é »é“çš„å‹è»å–®ä½ã€‚', target_book: 'B' }, 
            'loc_2': { i: 'ğŸ', n: 'è˜‹æœ', c: 'X4T9', cat: 'fruits', next: 'å‰å¾€ LOC 7', comm: 'ä¿æŒç•¶å‰é »é“ã€‚\nè«‹éœå€™å‹è»å–®ä½èˆ‡ä½ å€‘è¯ç¹«ã€‚', target_book: 'A' }, 
            'loc_3': { i: 'ğŸ¥', n: 'å¥‡ç•°æœ', c: 'J6H2', cat: 'fruits', next: 'å‰å¾€ LOC 6', comm: 'ä¿æŒç•¶å‰é »é“ã€‚\nè«‹éœå€™å‹è»å–®ä½èˆ‡ä½ å€‘è¯ç¹«ã€‚', target_book: 'D' }, 
            'loc_4': { i: 'ğŸ“', n: 'è‰è“', c: 'V1G5', cat: 'fruits', next: 'å‰å¾€ LOC 8', comm: 'åˆ‡æ›è‡³ [ä¸»é » CH2 / å‚™é » CH4]ã€‚\nåˆ‡æ›å¾Œï¼Œè«‹å‘¼å«è©²é »é“çš„å‹è»å–®ä½ã€‚', target_book: 'C' }, 
            'loc_5': { i: 'ğŸº', n: 'ç‹¼', c: 'F6B2', cat: 'animals', next: 'å‰å¾€ LOC 9', comm: 'åˆ‡æ›è‡³ [ä¸»é » CH1 / å‚™é » CH3]ã€‚\nåˆ‡æ›å¾Œï¼Œè«‹å‘¼å«è©²é »é“çš„å‹è»å–®ä½ã€‚', target_book: 'C' }, 
            'loc_6': { i: 'ğŸ¦', n: 'ç…å­', c: 'C7M1', cat: 'animals', next: 'å‰å¾€ LOC 11', comm: 'ä¿æŒç•¶å‰é »é“ã€‚\nè«‹éœå€™å‹è»å–®ä½èˆ‡ä½ å€‘è¯ç¹«ã€‚', target_book: 'D' }, 
            'loc_7': { i: 'ğŸ»', n: 'ç†Š', c: 'R3Z5', cat: 'animals', next: 'å‰å¾€ LOC 10', comm: 'åˆ‡æ›è‡³ [ä¸»é » CH2 / å‚™é » CH4]ã€‚\nåˆ‡æ›å¾Œï¼Œè«‹å‘¼å«è©²é »é“çš„å‹è»å–®ä½ã€‚', target_book: 'A' }, 
            'loc_8': { i: 'ğŸ¯', n: 'è€è™', c: 'Y5N8', cat: 'animals', next: 'å‰å¾€ LOC 12', comm: 'ä¿æŒç•¶å‰é »é“ã€‚\nè«‹éœå€™å‹è»å–®ä½èˆ‡ä½ å€‘è¯ç¹«ã€‚', target_book: 'B' }, 
            'loc_9': { i: 'ğŸ€', n: 'å¹¸é‹è‰', c: 'N9T4', cat: 'plants', next: 'MISSION COMPLETE', comm: 'åˆ‡æ›è‡³ [æ•‘æ´é »é“] å›å ± HQã€‚', target_book: 'B' }, 
            'loc_10': { i: 'ğŸŒµ', n: 'ä»™äººæŒ', c: 'H5I0', cat: 'plants', next: 'MISSION COMPLETE', comm: 'åˆ‡æ›è‡³ [æ•‘æ´é »é“] å›å ± HQã€‚', target_book: 'A' }, 
            'loc_11': { i: 'ğŸŒ´', n: 'æ¤°å­æ¨¹', c: 'C5Y9', cat: 'plants', next: 'MISSION COMPLETE', comm: 'åˆ‡æ›è‡³ [æ•‘æ´é »é“] å›å ± HQã€‚', target_book: 'D' }, 
            'loc_12': { i: 'ğŸŒ²', n: 'æ¾æ¨¹', c: 'J3R6', cat: 'plants', next: 'MISSION COMPLETE', comm: 'åˆ‡æ›è‡³ [æ•‘æ´é »é“] å›å ± HQã€‚', target_book: 'C' }    
        };

        const rescueCodes = {
            'fruits':  ['7001', '7002', '7003', '7004', '7005'],
            'animals': ['8001', '8002', '8003', '8004', '8005'],
            'plants':  ['9001', '9002', '9003', '9004', '9005']
        };

        const teamColors = { 'A': 'var(--alpha)', 'B': 'var(--bravo)', 'C': 'var(--charlie)', 'D': 'var(--delta)' };
        const teamNames = { 'A': 'ALPHA SQUAD', 'B': 'BRAVO SQUAD', 'C': 'CHARLIE SQUAD', 'D': 'DELTA SQUAD' };

        // --- 3. STATE MANAGEMENT ---
        const urlParams = new URLSearchParams(window.location.search);
        const missionId = urlParams.get('id');
        let missionData = null;

        let globalStatus = localStorage.getItem('global_device_status') || 'FRESH';
        let wrongAttempts = parseInt(localStorage.getItem(`attempts_${missionId}`)) || 0;
        let usedRescueCodes = JSON.parse(localStorage.getItem('used_rescue')) || [];

        // --- 4. INITIALIZATION ---
        window.onload = function() {
            // å¦‚æœç¶²å€æ²’æœ‰å¸¶ IDï¼Œé¡¯ç¤ºå°éšŠé¸æ“‡é¸å–® (å¯†ç¢¼æœ¬å…¥å£)
            if (!missionId || !missions[missionId]) {
                showScreen('squad-menu');
                return;
            }

            // å¦‚æœæœ‰å¸¶ IDï¼ŒåŸ·è¡Œä»»å‹™æµç¨‹
            missionData = missions[missionId];

            if (globalStatus === 'LOCKED') {
                showScreen('screen-locked');
            } else if (globalStatus === 'DISCHARGED') {
                showScreen('screen-cooldown');
            } else {
                showScreen('screen-pin');
            }
        };

        // --- 5. UI FUNCTIONS (å¯†ç¢¼æœ¬é‚è¼¯) ---

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(el => el.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            window.scrollTo(0, 0); 
        }

        function showCodeBook(teamId) {
            const seeds = TEAM_SEEDS[teamId];
            const color = teamColors[teamId];
            const name = teamNames[teamId];
            const contentArea = document.getElementById('book-content-area');
            const header = document.getElementById('book-header');

            header.innerText = name + " BOOK";
            header.style.backgroundColor = color;

            contentArea.innerHTML = '';
            
            // ä¾åºç”¢ç”Ÿä¸‰å¤§åˆ†é¡çš„è¡¨æ ¼ï¼šæ°´æœ -> å‹•ç‰© -> æ¤ç‰©
            createCategoryGrid(contentArea, 'FRUITS / æ°´æœ', MASTER_ASSETS.fruits, seeds, color, 0);
            createCategoryGrid(contentArea, 'ANIMALS / å‹•ç‰©', MASTER_ASSETS.animals, seeds, color, 12); // å‹•ç‰©å¾ç¬¬12å€‹é–‹å§‹
            createCategoryGrid(contentArea, 'PLANTS / æ¤ç‰©', MASTER_ASSETS.plants, seeds, color, 18); // æ¤ç‰©å¾ç¬¬18å€‹é–‹å§‹

            showScreen('codebook-view');
        }

        function createCategoryGrid(container, title, assets, allSeeds, color, offsetIndex) {
            // æ¨™é¡Œ
            const titleDiv = document.createElement('div');
            titleDiv.className = 'book-category-title';
            titleDiv.innerText = title;
            container.appendChild(titleDiv);

            // Grid å®¹å™¨
            const gridDiv = document.createElement('div');
            gridDiv.className = 'book-grid';

            assets.forEach((item, localIndex) => {
                // æ‰¾å‡ºé€™å€‹ç‰©å“å°æ‡‰çš„å…¨åŸŸ indexï¼Œä»¥ä¾¿å¾ SEEDS æ‹¿å¯†ç¢¼
                const globalIndex = offsetIndex + localIndex;
                const code = allSeeds[globalIndex] || '????';

                // å·¦å´ï¼šåœ–ç¤º + åç¨±
                const itemCol = document.createElement('div');
                itemCol.className = 'book-item-col';
                itemCol.innerHTML = `<span class="book-icon">${item.i}</span><span>${item.n}</span>`;
                
                // å³å´ï¼šå¯†ç¢¼
                const codeCol = document.createElement('div');
                codeCol.className = 'book-code-col';
                codeCol.innerText = code;
                codeCol.style.borderColor = color;
                codeCol.style.color = color;

                gridDiv.appendChild(itemCol);
                gridDiv.appendChild(codeCol);
            });

            container.appendChild(gridDiv);
        }

        // --- 6. MISSION LOGIC (ç¶­æŒä¸è®Š) ---

        function checkPin() {
            const pin = document.getElementById('pin-input').value;
            if (pin === '2758') {
                initMission();
            } else if (pin === '8964') {
                fullReset();
            } else {
                shakeElement(document.getElementById('pin-input'));
                document.getElementById('pin-input').value = '';
            }
        }

        function fullReset() {
            if(confirm('âš  SYSTEM RESET âš \nç¢ºå®šè¦é‡ç½®æ­¤è£ç½®çš„æ‰€æœ‰ç‹€æ…‹å—ï¼Ÿ')) {
                localStorage.clear();
                location.reload();
            }
        }

        function initMission() {
            document.getElementById('target-display').innerText = missionData.i;
            document.getElementById('target-name').innerText = missionData.n;
            updateAttemptsUI();
            showScreen('screen-mission');
        }

        function verifyCode() {
            const inputEl = document.getElementById('mission-input');
            let rawInput = inputEl.value.toUpperCase();
            let cleanInput = rawInput.replace(/[^A-Z0-9]/g, '');
            let fuzzyInput = cleanInput.replace(/0/g, 'O');
            let targetCode = missionData.c.replace(/0/g, 'O');
            
            if (fuzzyInput === targetCode) {
                localStorage.setItem('global_device_status', 'DISCHARGED');
                localStorage.removeItem(`attempts_${missionId}`);
                
                document.getElementById('success-next-loc').innerText = missionData.next;
                document.getElementById('success-comm-msg').innerText = missionData.comm;
                
                showScreen('screen-success');
            } else {
                wrongAttempts++;
                localStorage.setItem(`attempts_${missionId}`, wrongAttempts);
                shakeElement(inputEl);
                inputEl.value = '';
                
                if (wrongAttempts >= 3) {
                    lockSystem();
                } else {
                    updateAttemptsUI();
                }
            }
        }

        function updateAttemptsUI() {
            const el = document.getElementById('attempts-display');
            if (wrongAttempts > 0) {
                el.classList.remove('hidden');
                el.innerText = `âš  å¯†ç¢¼éŒ¯èª¤ (å‰©é¤˜ ${3 - wrongAttempts} æ¬¡æ©Ÿæœƒ)`;
            } else {
                el.classList.add('hidden');
            }
        }

        function lockSystem() {
            localStorage.setItem('global_device_status', 'LOCKED');
            globalStatus = 'LOCKED';
            showScreen('screen-locked');
        }

        // --- TAP TO UNLOCK LOGIC ---
        let tapCount = 0;
        let tapTimer;

        function unlockTap() {
            tapCount++;
            clearTimeout(tapTimer);
            if (tapCount >= 5) {
                tapCount = 0;
                document.getElementById('rescue-modal').classList.remove('hidden');
            }
            tapTimer = setTimeout(() => { tapCount = 0; }, 1000);
        }

        function attemptRescue() {
            const code = document.getElementById('rescue-input').value;
            const validCodes = rescueCodes[missionData.cat];

            if (!validCodes.includes(code)) { alert('ç„¡æ•ˆçš„æ•‘æ´ç¢¼'); return; }
            if (usedRescueCodes.includes(code)) { alert('æ•‘æ´ç¢¼å·²å¤±æ•ˆ'); return; }

            usedRescueCodes.push(code);
            localStorage.setItem('used_rescue', JSON.stringify(usedRescueCodes));
            
            wrongAttempts = 0;
            localStorage.setItem(`attempts_${missionId}`, 0);
            localStorage.setItem('global_device_status', 'FRESH');
            globalStatus = 'FRESH';
            
            document.getElementById('rescue-modal').classList.add('hidden');
            document.getElementById('rescue-input').value = '';
            
            showScreen('screen-mission');
            updateAttemptsUI();
        }

        // --- REBOOT LOGIC ---
        function showRebootModal() {
            document.getElementById('reboot-modal').classList.remove('hidden');
        }

        function attemptReboot() {
            const pin = document.getElementById('reboot-input').value;
            if (pin === '8964') {
                fullReset();
            } else {
                alert('ç„¡æ•ˆçš„ ADMIN PIN');
                document.getElementById('reboot-input').value = '';
            }
        }

        function shakeElement(el) {
            el.style.transform = 'translateX(10px)';
            setTimeout(() => el.style.transform = 'translateX(-10px)', 50);
            setTimeout(() => el.style.transform = 'translateX(10px)', 100);
            setTimeout(() => el.style.transform = 'translateX(0)', 150);
            el.style.borderColor = 'red';
            setTimeout(() => el.style.borderColor = 'var(--highlight)', 500);
        }

    </script>
</body>
</html>
