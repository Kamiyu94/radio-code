<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>FIELD TERMINAL V2 (ONLINE)</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg-color: #000000;
            --text-main: #e0e0e0;
            --highlight: #00ff41; /* V2 æ‹›ç‰Œç¶  */
            --danger: #ff3333;
            --panel-bg: #111111;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Consolas', 'Monaco', monospace;
            margin: 0;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .hidden { display: none !important; }

        /* --- 1. å°éšŠé¸æ“‡é¸å–® --- */
        #team-selector {
            height: 100%; width: 100%;
            display: flex; flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }
        
        .menu-title { text-align: center; color: var(--highlight); margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px;}
        
        .team-btn {
            width: 100%; padding: 25px; margin-bottom: 15px;
            font-size: 1.5rem; font-weight: bold; border-radius: 10px;
            background: #111; color: #fff; border: 2px solid #333;
            text-align: left; position: relative; cursor: pointer;
            transition: 0.2s;
        }
        .team-btn:active { transform: scale(0.98); filter: brightness(1.2); }
        .team-btn::after { content: '>'; position: absolute; right: 20px; opacity: 0.5; }

        /* --- 2. ä»»å‹™ä¸»ä»‹é¢ --- */
        #app { height: 100%; width: 100%; position: relative; }

        .screen { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            padding: 20px; padding-top: 10vh;
            background: #000; z-index: 10;
        }

        .input-box {
            background: #000; border: 2px solid var(--highlight); color: var(--highlight);
            font-size: 2rem; padding: 15px; width: 100%; max-width: 300px;
            text-align: center; border-radius: 8px; margin-bottom: 20px; outline: none;
            font-family: inherit; text-transform: uppercase;
        }

        .btn {
            background: #222; border: 1px solid var(--highlight); color: var(--highlight);
            padding: 15px 30px; font-size: 1.2rem; border-radius: 8px; cursor: pointer;
            width: 100%; max-width: 300px; font-weight: bold;
        }
        .btn:active { background: var(--highlight); color: #000; }

        /* ç‹€æ…‹ç•«é¢ */
        .status-icon { font-size: 5rem; margin-bottom: 20px; }
        .info-text { font-size: 1.2rem; color: #fff; margin-bottom: 10px; font-weight: bold; }
        .comm-msg { color: #ffcc00; white-space: pre-line; text-align: center; margin-top: 20px; border: 1px dashed #444; padding: 15px; width: 100%; }

        /* Loading Overlay - é€™æ˜¯æœ€é‡è¦çš„éƒ¨åˆ† */
        #loading {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 99;
            display: flex; flex-direction: column; justify-content: center; align-items: center; color: var(--highlight);
        }
        .loading-retry { margin-top: 20px; color: #fff; border: 1px solid #666; padding: 5px 15px; font-size: 0.8rem; cursor: pointer; display: none;}
    </style>
</head>
<body>

    <div id="loading">
        <div id="loading-text">CONNECTING TO SATELLITE...</div>
        <div class="loading-retry" onclick="location.reload()">RETRY CONNECTION</div>
    </div>

    <div id="team-selector" class="hidden">
        <h2 class="menu-title">SELECT SQUAD</h2>
        <button class="team-btn" style="border-color:#ff3333;" onclick="selectTeam('loc_1')">ğŸ”´ ALPHA TEAM</button>
        <button class="team-btn" style="border-color:#33ff33;" onclick="selectTeam('loc_2')">ğŸŸ¢ BRAVO TEAM</button>
        <button class="team-btn" style="border-color:#3388ff;" onclick="selectTeam('loc_3')">ğŸ”µ CHARLIE TEAM</button>
        <button class="team-btn" style="border-color:#ffff33;" onclick="selectTeam('loc_4')">ğŸŸ¡ DELTA TEAM</button>
        <div style="margin-top:20px; color:#666; font-size:0.8rem; text-align:center;">
            OR SCAN QR CODE AT LOCATION
        </div>
    </div>

    <div id="app" class="hidden">
        
        <div id="screen-input" class="screen">
            <div style="font-size:0.8rem; color:#666; width:100%; text-align:right; margin-bottom:20px;">ONLINE: <span id="session-id-disp">...</span></div>
            <div class="status-icon" id="target-icon">â“</div>
            <div class="info-text" id="target-name">Loading...</div>
            <p style="color:#888; margin-bottom:30px;">REQUEST CODE FROM ALLY</p>
            <input type="text" id="code-input" class="input-box" placeholder="CODE" maxlength="4">
            <button class="btn" onclick="submitCode()">VERIFY</button>
            <div id="error-msg" style="color:red; margin-top:15px; display:none;">ACCESS DENIED</div>
        </div>

        <div id="screen-success" class="screen hidden" style="background:#001a00;">
            <div class="status-icon">âœ…</div>
            <div class="info-text" style="color:var(--highlight);">ACCESS GRANTED</div>
            <div style="margin-top:20px; width:100%; max-width:320px;">
                <div style="color:#888; font-size:0.8rem;">NEXT OBJECTIVE</div>
                <div id="next-hint" class="info-text" style="font-size:1.5rem;">...</div>
            </div>
            <div class="comm-msg" id="comm-msg">...</div>
        </div>

        <div id="screen-wait" class="screen hidden">
            <div class="status-icon">â³</div>
            <div class="info-text">SYSTEM STANDBY</div>
            <p style="color:#666; text-align:center;">WAITING FOR HQ SIGNAL</p>
            <div style="color:#444; font-size:0.8rem; margin-top:10px;">è«‹æ•™å®˜åœ¨ HQ ç«¯å•Ÿå‹•æˆ°å±€</div>
            <button class="btn" style="margin-top:20px;" onclick="location.reload()">RECONNECT</button>
        </div>

    </div>

    <script>
        // --- 1. CONFIGURATION ---
        const SUPABASE_URL = 'https://lqhgpeuoejdyodanvauv.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxxaGdwZXVvZWpkeW9kYW52YXV2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1MDUyMzAsImV4cCI6MjA3OTA4MTIzMH0.my3U8mN06xm79ArFamTpWydf7rYFXOKT5-ooKmqb_O4';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let activeSessionId = null;
        let currentLocationId = null;
        let currentMissionData = null;

        // å®‰å…¨æ©Ÿåˆ¶ï¼šè¶…æ™‚é¡¯ç¤ºé‡è©¦
        setTimeout(() => {
            const retryBtn = document.querySelector('.loading-retry');
            if(retryBtn) retryBtn.style.display = 'block';
        }, 5000);

        // Helper: å®‰å…¨éš±è— loading (é¿å…æ‰¾ä¸åˆ°ç‰©ä»¶å ±éŒ¯)
        function hideLoading() {
            const el = document.getElementById('loading');
            if (el) el.style.display = 'none';
        }

        // --- 2. INITIALIZATION ---
        window.onload = async () => {
            const urlParams = new URLSearchParams(window.location.search);
            currentLocationId = urlParams.get('id');

            // æƒ…æ³ Aï¼šç¶²å€æ²’æœ‰ IDï¼Œé¡¯ç¤ºé¸å–®
            if (!currentLocationId) {
                hideLoading();
                const selector = document.getElementById('team-selector');
                if(selector) selector.classList.remove('hidden');
                return;
            }

            // æƒ…æ³ Bï¼šæœ‰ IDï¼Œé€²å…¥ä¸»ç¨‹å¼
            const app = document.getElementById('app');
            if(app) app.classList.remove('hidden');
            await checkSessionAndLoadMission();
        };

        function selectTeam(id) {
            window.location.href = `mission_v2.html?id=${id}`;
        }

        async function checkSessionAndLoadMission() {
            // A. æ‰¾æœ€æ–°çš„æ´»èºæˆ°å±€
            const { data: sessions, error } = await supabase
                .from('game_sessions')
                .select('id')
                .eq('is_active', true)
                .order('created_at', { ascending: false })
                .limit(1);

            // é€£ç·šå¤±æ•—æˆ–ç„¡æˆ°å±€
            if (error || !sessions || sessions.length === 0) {
                console.log("No active session found.");
                showScreen('screen-wait'); 
                hideLoading();
                return;
            }

            activeSessionId = sessions[0].id;
            const disp = document.getElementById('session-id-disp');
            if(disp) disp.innerText = activeSessionId.split('-')[0];

            // B. ç›£è½æˆ°å±€é‡ç½®
            supabase.channel('public:game_sessions')
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'game_sessions', filter: `id=eq.${activeSessionId}` }, 
                (payload) => {
                    if (payload.new.is_active === false) {
                        alert("MISSION TERMINATED BY HQ");
                        location.reload();
                    }
                }).subscribe();

            // C. è¼‰å…¥ä»»å‹™è³‡æ–™
            await loadMissionData();
        }

        async function loadMissionData() {
            const { data, error } = await supabase
                .from('mission_states')
                .select('*')
                .eq('session_id', activeSessionId)
                .eq('location_id', currentLocationId)
                .single();

            // æ‰¾ä¸åˆ°è³‡æ–™
            if (error || !data) {
                console.error("Mission data not found", error);
                hideLoading();
                alert("âš  ç„¡æ³•å–å¾—ä»»å‹™è³‡æ–™\n\nå¯èƒ½åŸå› ï¼š\n1. HQ å°šæœªåˆå§‹åŒ–æ–°æˆ°å±€\n2. è©²åœ°é» ID ç„¡æ•ˆ");
                showScreen('screen-wait');
                return;
            }

            currentMissionData = data;
            hideLoading();

            // D. åˆ¤æ–·æ˜¯å¦å·²è§£é–‹
            if (data.is_solved) {
                showSuccess(data);
            } else {
                showInput(data);
            }
        }

        function showInput(data) {
            showScreen('screen-input');
            document.getElementById('target-icon').innerText = data.icon;
            document.getElementById('target-name').innerText = data.name;
            document.getElementById('code-input').value = '';
            document.getElementById('error-msg').style.display = 'none';
        }

        function showSuccess(data) {
            showScreen('screen-success');
            document.getElementById('next-hint').innerText = data.next_hint;
            document.getElementById('comm-msg').innerText = data.comm_msg;
        }

        async function submitCode() {
            const input = document.getElementById('code-input').value.toUpperCase().trim();
            const correctCode = currentMissionData.code;

            if (input === correctCode) {
                // 1. æ›´æ–°è³‡æ–™åº«
                document.getElementById('loading').style.display = 'flex';
                const { error } = await supabase
                    .from('mission_states')
                    .update({ is_solved: true, solved_at: new Date() })
                    .eq('id', currentMissionData.id);

                if (error) {
                    alert("NETWORK ERROR: ç„¡æ³•å›å‚³æ•¸æ“š");
                    hideLoading();
                    return;
                }

                // 2. é¡¯ç¤ºæˆåŠŸ
                currentMissionData.is_solved = true; 
                showSuccess(currentMissionData);
                hideLoading();

            } else {
                // éŒ¯èª¤è™•ç†
                const errEl = document.getElementById('error-msg');
                errEl.style.display = 'block';
                errEl.innerText = "ACCESS DENIED";
                
                const box = document.getElementById('code-input');
                box.style.borderColor = 'red';
                setTimeout(() => box.style.borderColor = '#00ff41', 500);
            }
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(el => el.classList.add('hidden'));
            const el = document.getElementById(id);
            if(el) el.classList.remove('hidden');
        }

    </script>
</body>
</html>
