<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>FIELD TERMINAL V2 (ONLINE)</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg-color: #000000;
            --text-main: #e0e0e0;
            --highlight: #00ff41; 
            --danger: #ff3333;
            --panel-bg: #111111;
            
            /* å°éšŠä»£è¡¨è‰² */
            --alpha: #ff3333;
            --bravo: #33cc33;
            --charlie: #3388ff;
            --delta: #ffff33;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Consolas', 'Monaco', monospace;
            margin: 0;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .hidden { display: none !important; }

        /* --- 1. èº«åˆ†é¸æ“‡ç•«é¢ --- */
        #identity-screen {
            height: 100%; width: 100%;
            display: flex; flex-direction: column;
            padding: 20px; overflow-y: auto; align-items: center; justify-content: center;
            background: #050505; z-index: 300;
        }
        
        .id-title { font-size: 1.5rem; color: #fff; margin-bottom: 10px; font-weight: bold; letter-spacing: 2px; }
        .id-sub { font-size: 0.9rem; color: #666; margin-bottom: 30px; text-align: center; max-width: 300px;}
        
        .team-select-btn {
            width: 100%; max-width: 300px; padding: 20px; margin-bottom: 15px;
            font-size: 1.2rem; font-weight: 900; border-radius: 8px;
            background: #111; color: #fff; border: 2px solid #444;
            text-align: center; cursor: pointer; transition: 0.2s;
        }
        .team-select-btn:active { transform: scale(0.98); filter: brightness(1.2); }

        /* --- 2. å¯†ç¢¼æœ¬æª¢è¦– (Overlay) --- */
        #codebook-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #050505; z-index: 200; overflow-y: auto; padding: 20px; padding-bottom: 80px;
            display: flex; flex-direction: column; align-items: center;
        }
        
        .book-header { 
            width: 100%; padding: 15px; text-align: center; font-size: 1.5rem; font-weight: 900; 
            color: #fff; margin-bottom: 10px; border-radius: 8px; position: sticky; top: 0; z-index: 10;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        .book-category-title {
            width: 100%; max-width: 350px;
            color: #666; font-size: 0.8rem; margin-top: 20px; margin-bottom: 5px; border-bottom: 1px solid #333; padding-bottom: 2px;
        }

        .book-grid {
            display: grid; grid-template-columns: 1fr auto; gap: 8px;
            width: 100%; max-width: 350px; margin-bottom: 10px;
        }
        
        .book-item-col {
            display: flex; align-items: center; padding: 10px;
            background: rgba(255,255,255,0.05); border-radius: 6px 0 0 6px; font-size: 1rem;
        }
        .book-icon { font-size: 1.5rem; margin-right: 12px; }

        .book-code-col {
            display: flex; align-items: center; justify-content: center; padding: 10px; min-width: 100px;
            background: rgba(0,0,0,0.3); border: 1px solid var(--highlight); border-radius: 0 6px 6px 0;
            font-family: 'Consolas', monospace; font-size: 1.2rem; font-weight: 900; color: var(--highlight); letter-spacing: 1px;
        }

        .close-book-btn {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: #333; color: #fff; border: 1px solid #666; padding: 10px 30px; border-radius: 20px;
            font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.5); z-index: 210;
        }

        /* --- 3. ä»»å‹™ä¸»ä»‹é¢ --- */
        #app { height: 100%; width: 100%; position: relative; }

        .screen { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            padding: 20px; padding-top: 5vh; padding-bottom: 60px;
            background: #000; z-index: 10;
            overflow-y: auto; 
        }

        .input-box {
            background: #000; border: 2px solid var(--highlight); color: var(--highlight);
            font-size: 2rem; padding: 15px; width: 100%; max-width: 300px;
            text-align: center; border-radius: 8px; margin-bottom: 20px; outline: none;
            font-family: inherit; text-transform: uppercase;
        }

        .btn {
            background: #222; border: 1px solid var(--highlight); color: var(--highlight);
            padding: 15px 30px; font-size: 1.2rem; border-radius: 8px; cursor: pointer;
            width: 100%; max-width: 300px; font-weight: bold;
        }
        .btn:active { background: var(--highlight); color: #000; }

        /* å‘¼å«æç¤ºå€å¡Š */
        .call-card {
            border: 2px dashed #444; border-radius: 12px; padding: 20px; width: 100%; max-width: 320px;
            text-align: center; margin-bottom: 30px; background: rgba(255,255,255,0.05);
        }
        .call-label { color: #888; font-size: 0.9rem; display: block; margin-bottom: 10px; }
        .call-target { font-size: 1.8rem; font-weight: 900; display: block; letter-spacing: 1px; text-shadow: 0 0 10px rgba(0,0,0,0.5); }

        .my-book-btn {
            margin-top: 20px; margin-bottom: 30px; 
            background: #111; color: #fff; border: 1px solid #666;
            padding: 15px; width: 100%; max-width: 300px; font-size: 1rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 10px; border-radius: 8px;
        }
        
        .identity-badge {
            position: absolute; top: 10px; left: 10px; 
            font-size: 0.7rem; color: #666; border: 1px solid #333; padding: 2px 6px; border-radius: 4px;
        }

        /* ç‹€æ…‹ç•«é¢ */
        .status-icon { font-size: 5rem; margin-bottom: 20px; }
        .info-text { font-size: 1.2rem; color: #fff; margin-bottom: 10px; font-weight: bold; }
        .comm-msg { color: #ffcc00; white-space: pre-line; text-align: center; margin-top: 20px; border: 1px dashed #444; padding: 15px; width: 100%; }

        #loading {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 99;
            display: flex; flex-direction: column; justify-content: center; align-items: center; color: var(--highlight);
        }
        .loading-retry { margin-top: 20px; color: #fff; border: 1px solid #666; padding: 5px 15px; font-size: 0.8rem; cursor: pointer; display: none;}

        /* â˜… å…¨åŸŸæ‡¸æµ®é‡ç½®æŒ‰éˆ• â˜… */
        .floating-reset-btn {
            position: fixed; bottom: 15px; right: 15px;
            background: rgba(0,0,0,0.8); border: 1px solid #666; color: #666;
            padding: 8px 15px; border-radius: 20px; font-size: 0.75rem;
            z-index: 500; cursor: pointer; backdrop-filter: blur(5px);
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        .floating-reset-btn:hover { border-color: var(--danger); color: var(--danger); }

        /* â˜… ç®¡ç†å“¡å¯†ç¢¼ Modal â˜… */
        #admin-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 600;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
    </style>
</head>
<body>

    <div id="loading">
        <div id="loading-text">CONNECTING TO SATELLITE...</div>
        <div class="loading-retry" onclick="location.reload()">RETRY CONNECTION</div>
    </div>

    <div class="floating-reset-btn" onclick="openAdminModal()">âš  é‡ç½® / RESET</div>

    <div id="admin-modal" class="hidden">
        <h2 style="color:var(--danger);">ADMIN OVERRIDE</h2>
        <p style="color:#888; margin-bottom:20px;">è«‹è¼¸å…¥ HQ æˆæ¬Šç¢¼ä»¥é‡ç½®èº«åˆ†</p>
        <input type="number" id="admin-pin" class="input-box" placeholder="PIN" style="border-color:var(--danger); color:var(--danger);">
        <button class="btn" style="border-color:var(--danger); color:var(--danger);" onclick="confirmReset()">CONFIRM RESET</button>
        <button class="btn" style="border-color:#666; color:#666;" onclick="closeAdminModal()">CANCEL</button>
    </div>

    <div id="identity-screen" class="hidden">
        <div class="id-title">IDENTITY CHECK</div>
        <div class="id-sub">è«‹é¸æ“‡æ‚¨æ‰€å±¬çš„å°éšŠ<br>(ç¶å®šå¾Œç„¡æ³•æ›´æ”¹)</div>
        
        <div class="team-select-btn" style="border-color:var(--alpha); color:var(--alpha);" onclick="setIdentity('A')">ğŸ”´ ALPHA SQUAD</div>
        <div class="team-select-btn" style="border-color:var(--bravo); color:var(--bravo);" onclick="setIdentity('B')">ğŸŸ¢ BRAVO SQUAD</div>
        <div class="team-select-btn" style="border-color:var(--charlie); color:var(--charlie);" onclick="setIdentity('C')">ğŸ”µ CHARLIE SQUAD</div>
        <div class="team-select-btn" style="border-color:var(--delta); color:var(--delta);" onclick="setIdentity('D')">ğŸŸ¡ DELTA SQUAD</div>
    </div>

    <div id="codebook-overlay" class="hidden">
        <div id="book-header" class="book-header">MY BOOK</div>
        <div id="book-content" style="width:100%; display:flex; flex-direction:column; align-items:center;"></div>
        <button class="close-book-btn" onclick="closeCodeBook()">CLOSE BOOK</button>
    </div>

    <div id="app" class="hidden">
        <div id="screen-input" class="screen">
            <div class="identity-badge" id="identity-display">UNKOWN</div>
            <div style="font-size:0.8rem; color:#666; width:100%; text-align:right; margin-bottom:10px;">ONLINE: <span id="session-id-disp">...</span></div>
            
            <div class="status-icon" id="target-icon" style="font-size:4rem; margin-bottom:10px;">â“</div>
            <div class="info-text" id="target-name" style="margin-bottom:30px;">Loading...</div>
            
            <div class="call-card" id="call-card">
                <span class="call-label">RADIO FREQUENCY REQUIRED</span>
                <span class="call-label" style="font-size:0.8rem;">è«‹å‘¼å«ä¸‹æ–¹å°éšŠè©¢å•ä»£ç¢¼ï¼š</span>
                <span class="call-target" id="call-target-text">...</span>
            </div>
            
            <input type="text" id="code-input" class="input-box" placeholder="CODE" maxlength="4">
            <button class="btn" onclick="submitCode()">VERIFY</button>
            <div id="error-msg" style="color:red; margin-top:10px; display:none;">ACCESS DENIED</div>

            <button class="my-book-btn" onclick="openMyBook()"><span>ğŸ“– é–‹å•Ÿæˆ‘çš„å¯†ç¢¼æœ¬</span></button>
        </div>

        <div id="screen-success" class="screen hidden" style="background:#001a00;">
            <div class="status-icon">âœ…</div>
            <div class="info-text" style="color:var(--highlight);">ACCESS GRANTED</div>
            <div style="margin-top:20px; width:100%; max-width:320px;">
                <div style="color:#888; font-size:0.8rem;">NEXT OBJECTIVE</div>
                <div id="next-hint" class="info-text" style="font-size:1.5rem;">...</div>
            </div>
            <div class="comm-msg" id="comm-msg">...</div>
        </div>

        <div id="screen-wait" class="screen hidden">
            <div class="status-icon">â³</div>
            <div class="info-text">SYSTEM STANDBY</div>
            <p style="color:#666; text-align:center;">WAITING FOR HQ SIGNAL</p>
            <button class="btn" style="margin-top:20px;" onclick="location.reload()">RECONNECT</button>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        const SUPABASE_URL = 'https://lqhgpeuoejdyodanvauv.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxxaGdwZXVvZWpkeW9kYW52YXV2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1MDUyMzAsImV4cCI6MjA3OTA4MTIzMH0.my3U8mN06xm79ArFamTpWydf7rYFXOKT5-ooKmqb_O4';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // â˜… HQ æˆæ¬Šç¢¼è¨­å®š â˜…
        const ADMIN_PIN = "8888"; 

        // --- 2. éœæ…‹è³‡æ–™ ---
        const TEAM_INFO = {
            'A': { name: 'ALPHA SQUAD', color: 'var(--alpha)', display: 'ğŸ”´ ALPHA' },
            'B': { name: 'BRAVO SQUAD', color: 'var(--bravo)', display: 'ğŸŸ¢ BRAVO' },
            'C': { name: 'CHARLIE SQUAD', color: 'var(--charlie)', display: 'ğŸ”µ CHARLIE' },
            'D': { name: 'DELTA SQUAD', color: 'var(--delta)', display: 'ğŸŸ¡ DELTA' }
        };

        const SEEDS = {
            A: ["L2Z5", "P8K3", "S4M1", "T4W7", "X4T9", "Q4Y9", "B1D6", "K7X1", "V2C5", "O6A4", "U9E2", "Z3N7", "C7M1", "D5S2", "X2U5", "R9S6", "N3Y0", "G6P9", "G2V4", "B8H7", "L6P2", "F5G8", "Z7D5", "K3I6", "E2A4", "J3R6", "C6U3", "P8M5"],
            B: ["L3T6", "D8M3", "Z8A4", "W5Y3", "C5K1", "B2H9", "I1R8", "J9S0", "D1E5", "B6C9", "G7Q5", "U6Q4", "P5Q9", "B2C8", "H9I2", "D7E1", "W6X3", "U4V0", "F3G8", "H5I0", "U7V1", "L6N3", "Z7D5", "Z5A3", "B9C4", "O8P2", "W2Y6", "D1E8"],
            C: ["G5H0", "K1L9", "M6N4", "C9D1", "Q0R2", "A4B7", "E2F6", "U7V9", "I8J3", "W2X5", "V1G5", "O3P7", "C2D8", "L0M9", "N4O6", "T5U0", "V9W3", "D0E5", "L2M7", "J6K8", "A3B6", "H1I5", "D0E4", "V1W6", "A9B3", "F9G2", "X7Z2", "C0D5"],
            D: ["G6I4", "L1M7", "W7Z1", "P9R3", "C8D0", "Q4Y9", "C2D6", "K7X1", "U0V6", "E8F3", "N5O2", "S4T8", "C9E4", "U8V3", "M4N9", "W5X0", "S1T7", "C6D2", "O3P5", "Q8R1", "S2T6", "F5G8", "U7V4", "Z9A3", "D1E6", "L4M9", "B8C2", "F5G0"]
        };

        const MASTER_ASSETS = {
            fruits: [{n:"è‘¡è„", i:"ğŸ‡"}, {n:"è¥¿ç“œ", i:"ğŸ‰"}, {n:"æ©˜å­", i:"ğŸŠ"}, {n:"æª¸æª¬", i:"ğŸ‹"}, {n:"è˜‹æœ", i:"ğŸ"}, {n:"æ¢¨å­", i:"ğŸ"}, {n:"æ¤°å­", i:"ğŸ¥¥"}, {n:"èŠ’æœ", i:"ğŸ¥­"}, {n:"å“ˆå¯†ç“œ", i:"ğŸˆ"}, {n:"ç•ªèŒ„", i:"ğŸ…"}, {n:"è‰è“", i:"ğŸ“"}, {n:"é³³æ¢¨", i:"ğŸ"}],
            animals: [{n:"ç…å­", i:"ğŸ¦"}, {n:"è€é·¹", i:"ğŸ¦…"}, {n:"é±·é­š", i:"ğŸŠ"}, {n:"è²“é ­é·¹", i:"ğŸ¦‰"}, {n:"é•·é ¸é¹¿", i:"ğŸ¦’"}, {n:"è¢‹é¼ ", i:"ğŸ¦˜"}],
            plants: [{n:"å‘æ—¥è‘µ", i:"ğŸŒ»"}, {n:"ä»™äººæŒ", i:"ğŸŒµ"}, {n:"ç«¹å­", i:"ğŸ‹"}, {n:"æ‰¶æ¡‘èŠ±", i:"ğŸŒº"}, {n:"æ¥“è‘‰", i:"ğŸ"}, {n:"è–°è¡£è‰", i:"ğŸ’"}, {n:"è–„è·", i:"ğŸŒ¿"}, {n:"æ¾æ¨¹", i:"ğŸŒ²"}, {n:"é››èŠ", i:"ğŸŒ¼"}, {n:"è²æ®¼", i:"ğŸš"}]
        };

        const TARGET_MAPPING = {
            'loc_1': 'B', 'loc_2': 'A', 'loc_3': 'D', 'loc_4': 'C',
            'loc_5': 'C', 'loc_6': 'D', 'loc_7': 'A', 'loc_8': 'B',
            'loc_9': 'B', 'loc_10': 'A', 'loc_11': 'D', 'loc_12': 'C'
        };

        // --- 3. STATE MANAGEMENT ---
        let activeSessionId = null;
        let currentLocationId = null;
        let currentMissionData = null;
        let myIdentity = localStorage.getItem('my_squad_identity'); 

        // å®‰å…¨æ©Ÿåˆ¶
        setTimeout(() => {
            const retryBtn = document.querySelector('.loading-retry');
            if(retryBtn) retryBtn.style.display = 'block';
        }, 5000);

        function hideLoading() {
            const el = document.getElementById('loading');
            if (el) el.style.display = 'none';
        }

        // --- 4. INITIALIZATION ---
        window.onload = async () => {
            const urlParams = new URLSearchParams(window.location.search);
            currentLocationId = urlParams.get('id');

            // 1. åˆå§‹åŒ–æª¢æŸ¥ï¼šå¼·åˆ¶åŒæ­¥æ–°æˆ°å±€
            // é€™ä¸€æ­¥éå¸¸é‡è¦ï¼Œç¢ºä¿åœ¨è¼‰å…¥ä»»ä½•æ±è¥¿ä¹‹å‰ï¼Œå…ˆç¢ºèªæˆ°å±€æ˜¯å¦å·²éæœŸ
            await checkHeartbeat(true);

            // 2. æª¢æŸ¥èº«åˆ†
            if (!localStorage.getItem('my_squad_identity')) {
                hideLoading();
                document.getElementById('identity-screen').classList.remove('hidden');
                return; 
            }
            // é‡æ–°è®€å–ï¼ˆä»¥é˜²è¢«ä¸Šé¢æ¸…é™¤ï¼‰
            myIdentity = localStorage.getItem('my_squad_identity');

            // 3. æª¢æŸ¥ ID
            if (!currentLocationId) {
                hideLoading();
                alert("è«‹æƒæç¾å ´ QR Code ä»¥é€²å…¥ä»»å‹™");
                return;
            }

            // 4. æ­£å¸¸æµç¨‹
            document.getElementById('app').classList.remove('hidden');
            document.getElementById('identity-display').innerText = myIdentity + " SQUAD";
            await loadMissionData();

            // â˜… å•Ÿå‹•å¾ªç’°å¿ƒè·³åµæ¸¬
            setInterval(() => checkHeartbeat(false), 5000);
        };

        // --- 5. IDENTITY & ADMIN LOGIC ---
        function setIdentity(team) {
            if(confirm(`ç¢ºèªæ‚¨çš„èº«åˆ†ç‚º ${team} å°éšŠï¼Ÿ\nç¢ºèªå¾Œå°‡ç„¡æ³•æ›´æ”¹ã€‚`)) {
                localStorage.setItem('my_squad_identity', team);
                myIdentity = team;
                location.reload(); 
            }
        }

        function openAdminModal() {
            document.getElementById('admin-modal').classList.remove('hidden');
        }

        function closeAdminModal() {
            document.getElementById('admin-modal').classList.add('hidden');
            document.getElementById('admin-pin').value = '';
        }

        function confirmReset() {
            const pin = document.getElementById('admin-pin').value;
            if (pin === ADMIN_PIN) {
                if(confirm("âš  SYSTEM RESET âš \nç¢ºå®šè¦å¼·åˆ¶æ¸…é™¤æ­¤è£ç½®çš„èº«åˆ†å—ï¼Ÿ")) {
                    localStorage.removeItem('my_squad_identity');
                    location.reload();
                }
            } else {
                alert("æˆæ¬Šç¢¼éŒ¯èª¤ (ACCESS DENIED)");
                document.getElementById('admin-pin').value = '';
            }
        }

        // --- 6. HEARTBEAT & MISSION LOGIC ---
        
        // â˜… è‡ªå‹•æª¢æŸ¥æ–°æˆ°å±€ (æœ€é—œéµçš„ä¿®å¾©)
        async function checkHeartbeat(isInit = false) {
            const { data: sessions } = await supabase
                .from('game_sessions')
                .select('id')
                .eq('is_active', true)
                .order('created_at', { ascending: false })
                .limit(1);

            if (sessions && sessions.length > 0) {
                const latestId = sessions[0].id;
                const localSession = localStorage.getItem('last_active_session_id');

                // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡åŸ·è¡Œ(isInit)ï¼Œä¸”æœ¬åœ°æ²’æœ‰ç´€éŒ„ï¼Œå°±å­˜ä¸‹ä¾†
                if (isInit && !localSession) {
                    localStorage.setItem('last_active_session_id', latestId);
                    activeSessionId = latestId;
                    return;
                }

                // å¦‚æœè³‡æ–™åº«çš„ ID èˆ‡ æœ¬åœ°å­˜çš„ ID ä¸åŒ -> ä»£è¡¨ HQ é‡å•Ÿäº†
                if (localSession && latestId !== localSession) {
                    console.log("ğŸ”¥ NEW SESSION DETECTED! FORCING RESET.");
                    alert("âš ï¸ HQ å·²é‡ç½®æˆ°å±€ âš ï¸\n\nç³»çµ±å°‡è‡ªå‹•åˆ·æ–°ä¸¦æ¸…é™¤èº«åˆ†è¨­å®šã€‚");
                    
                    // å¼·åˆ¶æ¸…é™¤æ‰€æœ‰ç‹€æ…‹
                    localStorage.removeItem('my_squad_identity');
                    localStorage.setItem('last_active_session_id', latestId);
                    
                    location.reload();
                    return;
                }
                
                // æ›´æ–°ç•¶å‰è¨˜æ†¶é«”ä¸­çš„ ID
                activeSessionId = latestId;
                if(document.getElementById('session-id-disp')) {
                    document.getElementById('session-id-disp').innerText = activeSessionId.split('-')[0];
                }
            }
        }

        async function loadMissionData() {
            if(!activeSessionId) return;

            const { data, error } = await supabase
                .from('mission_states')
                .select('*')
                .eq('session_id', activeSessionId)
                .eq('location_id', currentLocationId)
                .single();

            if (error || !data) {
                console.error("Mission data not found", error);
                hideLoading();
                alert("âš  ç„¡æ³•å–å¾—ä»»å‹™è³‡æ–™\n(è«‹ç¢ºèª HQ å·²å•Ÿå‹•æˆ°å±€)");
                showScreen('screen-wait');
                return;
            }

            currentMissionData = data;
            hideLoading();

            if (data.is_solved) {
                showSuccess(data);
            } else {
                showInput(data);
            }
            
            // è¨‚é–±ç›£è½ (ç¢ºä¿å³æ™‚æ›´æ–°)
            const channel = supabase.channel('room-global')
            .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'mission_states', filter: `id=eq.${data.id}` }, (payload) => {
                if (payload.new.is_solved) {
                    currentMissionData.is_solved = true;
                    showSuccess(payload.new);
                }
            }).subscribe();
        }

        function showInput(data) {
            showScreen('screen-input');
            document.getElementById('target-icon').innerText = data.icon;
            document.getElementById('target-name').innerText = data.name;
            document.getElementById('code-input').value = '';
            document.getElementById('error-msg').style.display = 'none';

            const targetTeamCode = TARGET_MAPPING[currentLocationId];
            if (targetTeamCode) {
                const targetInfo = TEAM_INFO[targetTeamCode];
                const targetText = document.getElementById('call-target-text');
                const callCard = document.getElementById('call-card');
                
                targetText.innerText = targetInfo.display;
                targetText.style.color = targetInfo.color;
                callCard.style.borderColor = targetInfo.color;
            }
        }

        function showSuccess(data) {
            showScreen('screen-success');
            document.getElementById('next-hint').innerText = data.next_hint;
            document.getElementById('comm-msg').innerText = data.comm_msg;
        }

        async function submitCode() {
            const input = document.getElementById('code-input').value.toUpperCase().trim();
            const correctCode = currentMissionData.code;

            if (input === correctCode) {
                document.getElementById('loading').style.display = 'flex';
                const { error } = await supabase
                    .from('mission_states')
                    .update({ is_solved: true, solved_at: new Date() })
                    .eq('id', currentMissionData.id);

                if (error) {
                    alert("NETWORK ERROR: ç„¡æ³•å›å‚³æ•¸æ“š");
                    hideLoading();
                    return;
                }
                // æœ¬åœ°å…ˆæ›´æ–°ï¼Œä¸ç­‰ç›£è½
                currentMissionData.is_solved = true; 
                showSuccess(currentMissionData);
                hideLoading();

            } else {
                const errEl = document.getElementById('error-msg');
                errEl.style.display = 'block';
                errEl.innerText = "ACCESS DENIED";
                const box = document.getElementById('code-input');
                box.style.borderColor = 'red';
                setTimeout(() => box.style.borderColor = '#00ff41', 500);
            }
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(el => el.classList.add('hidden'));
            const el = document.getElementById(id);
            if(el) el.classList.remove('hidden');
        }

        // --- 7. BOOK UI ---
        function openMyBook() {
            if (!myIdentity) return;
            const seeds = SEEDS[myIdentity];
            const info = TEAM_INFO[myIdentity];
            const contentArea = document.getElementById('book-content');
            const header = document.getElementById('book-header');

            header.innerText = info.name + " BOOK";
            header.style.backgroundColor = info.color;
            contentArea.innerHTML = '';
            
            createCategoryGrid(contentArea, 'FRUITS / æ°´æœ', MASTER_ASSETS.fruits, seeds, info.color, 0);
            createCategoryGrid(contentArea, 'ANIMALS / å‹•ç‰©', MASTER_ASSETS.animals, seeds, info.color, 12);
            createCategoryGrid(contentArea, 'PLANTS / æ¤ç‰©', MASTER_ASSETS.plants, seeds, info.color, 18);

            document.getElementById('codebook-overlay').classList.remove('hidden');
        }

        function closeCodeBook() {
            document.getElementById('codebook-overlay').classList.add('hidden');
        }

        function createCategoryGrid(container, title, assets, allSeeds, color, offsetIndex) {
            const titleDiv = document.createElement('div');
            titleDiv.className = 'book-category-title';
            titleDiv.innerText = title;
            container.appendChild(titleDiv);

            const gridDiv = document.createElement('div');
            gridDiv.className = 'book-grid';

            assets.forEach((item, localIndex) => {
                const globalIndex = offsetIndex + localIndex;
                const code = allSeeds[globalIndex] || '????';

                const itemCol = document.createElement('div');
                itemCol.className = 'book-item-col';
                itemCol.innerHTML = `<span class="book-icon">${item.i}</span><span>${item.n}</span>`;
                
                const codeCol = document.createElement('div');
                codeCol.className = 'book-code-col';
                codeCol.innerText = code;
                codeCol.style.borderColor = color;
                codeCol.style.color = color;

                gridDiv.appendChild(itemCol);
                gridDiv.appendChild(codeCol);
            });
            container.appendChild(gridDiv);
        }

    </script>
</body>
</html>
