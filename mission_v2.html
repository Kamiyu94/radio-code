<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TACTICAL TERMINAL</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        :root { --bg: #000; --text: #0f0; --border: #333; --highlight: #00ff41; --error: #ff3333; }
        body { background: var(--bg); color: var(--text); font-family: 'Consolas', monospace; margin: 0; padding: 20px; display: flex; flex-direction: column; height: 100vh; align-items: center; justify-content: center; text-align: center; }
        
        .container { width: 100%; max-width: 400px; }
        
        /* HEADER */
        .header { border-bottom: 2px solid var(--highlight); padding-bottom: 10px; margin-bottom: 30px; width: 100%; }
        h1 { margin: 0; font-size: 1.5rem; letter-spacing: 2px; text-shadow: 0 0 5px rgba(0, 255, 65, 0.5); }
        .sub-header { font-size: 0.8rem; color: #666; margin-top: 5px; }

        /* ICON AREA */
        .icon-box { font-size: 5rem; margin-bottom: 20px; animation: pulse 2s infinite; }
        .target-name { font-size: 1.5rem; font-weight: bold; margin-bottom: 5px; color: #fff; }
        .loc-id { font-size: 0.9rem; color: #888; margin-bottom: 20px; border: 1px solid #333; display: inline-block; padding: 2px 8px; border-radius: 4px; }

        /* INPUT AREA */
        input[type="tel"] { 
            background: #111; border: 2px solid #444; color: var(--highlight); 
            font-family: inherit; font-size: 2rem; text-align: center; 
            width: 100%; padding: 15px; border-radius: 8px; margin-bottom: 20px; 
            letter-spacing: 5px; outline: none; transition: 0.3s;
        }
        input:focus { border-color: var(--highlight); box-shadow: 0 0 15px rgba(0, 255, 65, 0.3); }
        
        .btn { 
            background: var(--highlight); color: #000; border: none; 
            width: 100%; padding: 15px; font-size: 1.2rem; font-weight: bold; 
            cursor: pointer; text-transform: uppercase; border-radius: 8px; 
        }
        .btn:active { transform: scale(0.98); opacity: 0.8; }

        /* SUCCESS SCREEN */
        .success-panel { display: none; flex-direction: column; align-items: center; width: 100%; }
        .success-msg { color: var(--highlight); font-size: 1.2rem; margin-bottom: 20px; border: 1px dashed var(--highlight); padding: 15px; width: 100%; }
        .comm-msg { color: #fff; font-size: 1rem; margin-top: 10px; white-space: pre-wrap; text-align: left; background: #111; padding: 15px; border-left: 3px solid var(--highlight); }
        
        /* LOADING & ERROR */
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); display:flex; justify-content:center; align-items:center; z-index:99; }
        .error-msg { color: var(--error); margin-top: 10px; font-size: 0.9rem; min-height: 20px; }

        @keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 1; text-shadow: 0 0 20px var(--highlight); } 100% { opacity: 0.8; } }
        
        /* éš±è—å€å¡Š */
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="loading"><div>CONNECTING...</div></div>

    <div class="container" id="game-panel">
        <div class="header">
            <h1>ACCESS TERMINAL</h1>
            <div class="sub-header">SECURE CONNECTION ESTABLISHED</div>
        </div>

        <div id="mission-content" class="hidden">
            <div class="icon-box" id="target-icon">â“</div>
            <div class="target-name" id="target-name">TARGET LOCKED</div>
            <div class="loc-id" id="loc-display">LOC-??</div>
            
            <input type="tel" id="code-input" placeholder="____" maxlength="4" autocomplete="off">
            <button class="btn" onclick="submitCode()">UNLOCK</button>
            <div class="error-msg" id="status-msg"></div>
        </div>

        <div id="success-content" class="success-panel">
            <div style="font-size: 4rem; margin-bottom: 10px;">ğŸ”“</div>
            <h2 style="margin: 0 0 20px 0;">ACCESS GRANTED</h2>
            
            <div class="success-msg">
                <div style="font-size: 0.8rem; color: #888; margin-bottom: 5px;">NEXT HINT</div>
                <div id="next-hint" style="font-weight: bold; font-size: 1.4rem;">-</div>
            </div>

            <div class="comm-msg" id="comm-msg">
                -
            </div>
        </div>

        <div id="error-content" class="hidden">
            <h2 style="color:var(--error)">SIGNAL LOST</h2>
            <p id="error-detail" style="color:#888">No active mission found.</p>
            <button class="btn" style="background:#333; color:#fff; margin-top:20px;" onclick="location.reload()">RETRY</button>
        </div>
    </div>

    <script>
        // 1. CONFIGURATION (èˆ‡ HQ ä¿æŒä¸€è‡´)
        const SUPABASE_URL = 'https://lqhgpeuoejdyodanvauv.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxxaGdwZXVvZWpkeW9kYW52YXV2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1MDUyMzAsImV4cCI6MjA3OTA4MTIzMH0.my3U8mN06xm79ArFamTpWydf7rYFXOKT5-ooKmqb_O4';
        
        // ã€ä¿®æ­£é‡é»ã€‘ä½¿ç”¨ db è€Œé supabaseï¼Œé¿å…è®Šæ•¸è¡çª
        const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // 2. STATE
        let currentMission = null;
        let activeSessionId = null;

        // 3. INIT
        window.onload = async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const locId = urlParams.get('id'); // ä¾‹å¦‚ loc_1

            if (!locId) {
                showError("INVALID LINK: MISSING LOCATION ID");
                return;
            }

            // æª¢æŸ¥æœ¬åœ°æ˜¯å¦å·²ç¶“è§£éé€™é¡Œ (é›¢ç·šå¿«å–æ©Ÿåˆ¶)
            const localSolved = localStorage.getItem(`solved_${locId}`);
            if (localSolved) {
                // å¦‚æœå·²ç¶“è§£éï¼Œç›´æ¥é¡¯ç¤ºçµæœï¼Œä¸ç”¨é€£ç¶²æŸ¥ (çœæµé‡ä¸”å¿«)
                showSuccess(JSON.parse(localSolved));
                document.getElementById('loading').style.display = 'none';
                return;
            }

            // é€£ç¶²å–å¾—ç›®å‰æ´»èºçš„ Session
            const { data: sessions, error: sessionError } = await db.from('game_sessions')
                .select('id')
                .eq('is_active', true)
                .order('created_at', { ascending: false })
                .limit(1);

            if (sessionError || !sessions || sessions.length === 0) {
                showError("SYSTEM OFFLINE: NO ACTIVE GAME FOUND");
                return;
            }
            activeSessionId = sessions[0].id;

            // å–å¾—è©² Session ä¸­ï¼Œæ­¤ Location çš„ä»»å‹™è³‡è¨Š
            const { data: mission, error: missionError } = await db.from('mission_states')
                .select('*')
                .eq('session_id', activeSessionId)
                .eq('location_id', locId)
                .single();

            if (missionError || !mission) {
                showError(`TARGET NOT FOUND: ${locId.toUpperCase()}`);
                return;
            }

            currentMission = mission;
            renderMission(mission);
        };

        function renderMission(mission) {
            document.getElementById('loading').style.display = 'none';
            
            // å¦‚æœé€™é¡Œå·²ç¶“è¢«åˆ¥äººè§£é–‹äº†ï¼Œä¹Ÿç›´æ¥é¡¯ç¤ºæˆåŠŸ
            if (mission.is_solved) {
                saveToLocal(mission); // è£œå­˜åˆ°æœ¬åœ°
                showSuccess(mission);
                return;
            }

            // é¡¯ç¤ºè§£é¡Œä»‹é¢
            document.getElementById('mission-content').classList.remove('hidden');
            document.getElementById('target-icon').innerText = mission.icon;
            document.getElementById('target-name').innerText = mission.name;
            document.getElementById('loc-display').innerText = mission.location_id.toUpperCase();
        }

        async function submitCode() {
            const inputEl = document.getElementById('code-input');
            const statusEl = document.getElementById('status-msg');
            const userCode = inputEl.value.trim().toUpperCase();

            if (!userCode) return;

            // ã€åŠŸèƒ½ã€‘è¼¸å…¥ 8964 é‡ç½®æœ¬åœ°è³‡æ–™ (çµ¦æ•™å®˜/åŠ©æ•™ç”¨)
            if (userCode === '8964') {
                if(confirm('RESET DEVICE DATA?')) {
                    localStorage.clear();
                    location.reload();
                }
                return;
            }

            // æ¯”å°å¯†ç¢¼
            if (userCode === currentMission.code) {
                // 1. æˆåŠŸï¼šæ›´æ–° UI
                statusEl.innerText = "VERIFYING...";
                statusEl.style.color = "var(--highlight)";
                
                // 2. å¯«å…¥è³‡æ–™åº« (é€šçŸ¥ HQ)
                const { error } = await db.from('mission_states')
                    .update({ is_solved: true })
                    .eq('id', currentMission.id);

                if (error) {
                    statusEl.innerText = "UPLOAD FAILED. RETRY.";
                    statusEl.style.color = "var(--error)";
                    return;
                }

                // 3. å„²å­˜åˆ°æœ¬åœ° (é¿å…é‡æ•´å¾Œé‚„è¦é‡è§£)
                currentMission.is_solved = true;
                saveToLocal(currentMission);

                // 4. é¡¯ç¤ºéé—œç•«é¢
                document.getElementById('mission-content').classList.add('hidden');
                showSuccess(currentMission);

            } else {
                // å¤±æ•—
                statusEl.innerText = "ACCESS DENIED";
                statusEl.style.color = "var(--error)";
                inputEl.value = '';
                inputEl.focus();
                
                // éœ‡å‹•å›é¥‹
                if(navigator.vibrate) navigator.vibrate(200);
            }
        }

        function showSuccess(mission) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('mission-content').classList.add('hidden');
            document.getElementById('success-content').style.display = 'flex';
            
            document.getElementById('next-hint').innerText = mission.next_hint;
            document.getElementById('comm-msg').innerText = mission.comm_msg || "Awaiting further instructions...";
        }

        function saveToLocal(mission) {
            // åªå­˜é¡¯ç¤ºéœ€è¦çš„è³‡æ–™ï¼Œç•¶ä½œ cache
            const cacheData = {
                next_hint: mission.next_hint,
                comm_msg: mission.comm_msg
            };
            localStorage.setItem(`solved_${mission.location_id}`, JSON.stringify(cacheData));
        }

        function showError(msg) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('game-panel').classList.add('hidden');
            document.getElementById('error-content').classList.remove('hidden');
            document.getElementById('error-detail').innerText = msg;
        }

    </script>
</body>
</html>
